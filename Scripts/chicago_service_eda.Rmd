---
title: "COVID Impact on Chicago Service Workers-EDA"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("functions.R")
library(tidycensus)
library(tidyverse)
zip_code <- read_csv("../Data/zip_county.csv")
zip_code_chicago <- zip_code %>% filter(primary_city == "Chicago",
                                        state == "IL")
variables_2018 <- load_variables(2018, "acs5", cache = TRUE) %>%
  rename(variable = name)
state_of_interest <- ("IL")
```

## Maya Frederick

Sex by age and citizenship status
```{r}
chicago_citizen <- get_acs(geography = "zcta",
                        year = 2018,
                        table = "B05003") %>% 
                  filter(GEOID %in% zip_code_chicago$zip,
                         !variable %in% c("B05003_001"))
chicago_citizen <- left_join(chicago_citizen, variables_2018[, 1:2], by = "variable")

chicago_citizen <- chicago_citizen %>% filter(str_count(label, "!!") >= 4)
chicago_citizen$label <- str_remove(chicago_citizen$label, "Estimate!!Total!!") 

chicago_citizen <- chicago_citizen %>% filter(!str_detect(label,"Foreign born$"))
chicago_citizen$label <- str_remove(chicago_citizen$label, "Foreign born!!") 

# Created another column because of the fact that some of the citizens only had 3 "!!"'s and some had 4. 
# I just need it to help determine the citizenship status, I delete it later. 
chicago_citizen <- separate(chicago_citizen,
                    label,
                    sep = "!!",
                    into = c("Sex", "Age", "Citizen"))

chicago_citizen$Citizen <- if_else(
  chicago_citizen$Citizen == "Not a U.S. citizen", "No", "Yes")
```

### Dr. Weber's Code

The following code will calculate the proportion of the ZIP code populations that fit into each category. We always need to group by GEOID since we want these numbers per ZIP code. Next, we calculate the total ZIP code population. After that, we do a series of `group_by()`, `mutate()` commands to be able to calculate the proportions for each categorical breakdown. Note the naming conventions for the new columns. Also note that I've created a new data frame to house these proportions as to not mess up the original data pulled from the ACS. You should do this for all possible one-way, two-way, three-way, etc. factorial combinations of the categories (e.g., Sex, Age, Citizen, Sex-Age, Sex-Citizen, Age-Citizen, Sex-Age-Citizen). Also note the algorithmic nature of constructing the factorial combinations. 

```{r}
chicago_citizen_2 <- chicago_citizen %>% 
  arrange(GEOID) %>% 
  group_by(GEOID) %>% 
  mutate(zip_pop = sum(estimate)) %>% 
  group_by(GEOID, Sex) %>% 
  mutate(prop_sex = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Age) %>% 
  mutate(prop_age = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Citizen) %>% 
  mutate(prop_cit = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Sex, Age) %>% 
  mutate(prop_sex_age = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Sex, Citizen) %>% 
  mutate(prop_sex_cit = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Age, Citizen) %>% 
  mutate(prop_age_cit = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Sex, Age, Citizen) %>% 
  mutate(prop_sex_age_cit = sum(estimate)/zip_pop)
```

## Ethan Morlock
```{r}
# Sex by age (Hispanic or Latino)
chicago_sex_age <- get_acs(geography = "zcta",
                                   year = 2018,
                                   table = "B01001I") %>% 
                              filter(GEOID %in% zip_code_chicago$zip,
                                     !variable %in% c("B01001I_001", "B01001I_002", "B01001I_017"))
chicago_sex_age <- left_join(chicago_sex_age, variables_2018[, 1:2], by = "variable")
chicago_sex_age$label <- str_remove(chicago_sex_age$label, "Estimate!!Total!!")
chicago_sex_age <- separate(chicago_sex_age,
                    label,
                    sep = "!!",
                    into = c("Sex", "Age"))
chicago_sex_age$Sex <- as_factor(chicago_sex_age$Sex)
chicago_sex_age$Age <- as_factor(chicago_sex_age$Age)
write_csv(chicago_sex_age, "../Data/chicago_sex_age.csv")

chicago_sex_age_2 <- chicago_sex_age %>% 
  arrange(GEOID) %>% 
  group_by(GEOID) %>% 
  mutate(zip_pop = sum(estimate)) %>% 
  group_by(GEOID, Sex) %>% 
  mutate(prop_sex = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Age) %>% 
  mutate(prop_age = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Sex, Age) %>% 
  mutate(prop_sex_age = sum(estimate)/zip_pop) 
write_csv(chicago_sex_age_2, "../Data/chicago_sex_age_2.csv")
```

```{r}
# Health insurance coverage status by sex by age 
chicago_HI <- get_acs(geography = "zcta",
                   year = 2018,
                   table = "B27001") %>% 
              filter(GEOID %in% zip_code_chicago$zip,
                     !variable %in% c("B27001_001", "B27001_002", "B27001_003", "B27001_006", "B27001_009", "B27001_012",
                                      "B27001_015", "B27001_018", "B27001_021", "B27001_024", "B27001_027", "B27001_030", "B27001_031",
                                      "B27001_034", "B27001_037", "B27001_040", "B27001_043", "B27001_046", "B27001_049", "B27001_052",
                                      "B27001_055"))
chicago_HI <- left_join(chicago_HI, variables_2018[, 1:2], by = "variable")
chicago_HI$label <- str_remove(chicago_HI$label, "Estimate!!Total!!")
chicago_HI <- separate(chicago_HI,
                    label,
                    sep = "!!",
                    into = c("Sex", "Age", "HI_coverage"))
chicago_HI$HI_coverage <- if_else(chicago_HI$HI_coverage == "With health insurance coverage", "Yes", "No")
chicago_HI$Sex <- as_factor(chicago_HI$Sex)
chicago_HI$Age <- as_factor(chicago_HI$Age)
chicago_HI$HI_coverage <- as_factor(chicago_HI$HI_coverage)
write_csv(chicago_HI, "../Data/chicago_HI.csv")

chicago_HI_2 <- chicago_HI %>% 
  arrange(GEOID) %>% 
  group_by(GEOID) %>% 
  mutate(zip_pop = sum(estimate)) %>% 
  group_by(GEOID, Sex) %>% 
  mutate(prop_sex = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Age) %>% 
  mutate(prop_age = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, HI_coverage) %>% 
  mutate(prop_HI_cov = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Sex, Age) %>% 
  mutate(prop_sex_age = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Sex, HI_coverage) %>% 
  mutate(prop_sex_HI_cov = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Age, HI_coverage) %>% 
  mutate(prop_age_HI_cov = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Sex, Age, HI_coverage) %>% 
  mutate(prop_sex_age_HI_cov = sum(estimate)/zip_pop)
write_csv(chicago_HI_2, "../Data/chicago_HI_2.csv")
```

```{r}
# Race (Hispanic or Latino)
chicago_race <- get_acs(geography = "zcta",
                     year = 2018,
                     table = "B03002") %>% 
                filter(GEOID %in% zip_code_chicago$zip,
                       variable %in% c(str_c("B03002_00", 3:9), str_c("B03002_0", 13:19)))
chicago_race <- left_join(chicago_race, variables_2018[, 1:2], by = "variable")
chicago_race$label <- str_remove(chicago_race$label, "Estimate!!Total!!")
chicago_race <- separate(chicago_race,
                    label,
                    sep = "!!",
                    into = c("Hispanic_or_Latino", "Race"))
chicago_race$Hispanic_or_Latino <- if_else(chicago_race$Hispanic_or_Latino == "Not Hispanic or Latino", "No", "Yes")
chicago_race$Race <- if_else(chicago_race$Race == "White alone", "White",
                      if_else(chicago_race$Race == "Black or African American alone", "Black",
                        if_else(chicago_race$Race == "American Indian and Alaska Native alone", "AIAN", 
                          if_else(chicago_race$Race == "Asian alone", "Asian", 
                            if_else(chicago_race$Race == "Native Hawaiian and Other Pacific Islander alone", "NHPI", 
                              if_else(chicago_race$Race == "Some other race alone", "Other", "Two or more"))))))
chicago_race$Hispanic_or_Latino <- as_factor(chicago_race$Hispanic_or_Latino)
chicago_race$Race <- as_factor(chicago_race$Race)
write_csv(chicago_race, "../Data/chicago_race.csv")

chicago_race_2 <- chicago_race %>% 
  arrange(GEOID) %>% 
  group_by(GEOID) %>% 
  mutate(zip_pop = sum(estimate)) %>% 
  group_by(GEOID, Hispanic_or_Latino) %>% 
  mutate(prop_His_Lat = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Race) %>% 
  mutate(prop_Race = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Hispanic_or_Latino, Race) %>% 
  mutate(prop_His_Lat_Race = sum(estimate)/zip_pop)
write_csv(chicago_race_2, "../Data/chicago_race_2.csv")

chicago_race_ex <- chicago_race_2 %>%
  filter(variable == "B03002_003") # no, white

chicago_race_ex <- chicago_race_ex %>%
  rename(prop_not_His = prop_His_Lat,
         prop_White = prop_Race,
         prop_not_His_White = prop_His_Lat_Race)
```


## Pearl Muensterman
```{r}
#Industry by Class Worker
chicago_ind_by_class <- get_acs(geography = "zcta",
                        year = 2018,
                        table = "C24070") %>% 
                  filter(GEOID %in% zip_code_chicago$zip)
chicago_ind_by_class <- left_join(chicago_ind_by_class, variables_2018[, 1:2], by = "variable")
chicago_ind_by_class <- chicago_ind_by_class %>% filter(str_count(label, "!!") >= 3)

chicago_ind_by_class$label <- str_remove(chicago_ind_by_class$label, "Estimate!!Total!!")

chicago_ind_by_class <- separate(chicago_ind_by_class,
                    label,
                    sep = "!!",
                    into = c("Class", "Industry"))

chicago_ind_by_class$Class <- as.factor(chicago_ind_by_class$Class)
chicago_ind_by_class$Industry <- as.factor(chicago_ind_by_class$Industry)
  

chicago_ind_by_class <- chicago_ind_by_class %>% mutate(Service_Worker = chicago_ind_by_class$Industry)

chicago_ind_by_class$Service_Worker <- if_else((chicago_ind_by_class$Service_Worker == "Construction" | chicago_ind_by_class$Service_Worker == "Manufacturing" | chicago_ind_by_class$Service_Worker == "Retail trade" | chicago_ind_by_class$Service_Worker == "Transportation and warehousing, and utilities"), "Yes", "No")

chicago_ind_by_class_2 <- chicago_ind_by_class %>% 
  arrange(GEOID) %>% 
  group_by(GEOID) %>% 
  mutate(zip_pop = sum(estimate)) %>% 
  group_by(GEOID, Class) %>% 
  mutate(prop_class = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Industry) %>% 
  mutate(prop_ind = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Service_Worker) %>% 
  mutate(prop_service = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Class, Industry) %>% 
  mutate(prop_class_ind = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Class, Service_Worker) %>% 
  mutate(prop_class_service = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Industry, Service_Worker) %>% 
  mutate(prop_ind_service = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Class, Industry, Service_Worker) %>% 
  mutate(prop_class_ind_service = sum(estimate)/zip_pop)
```


```{r}
#Sex by Age Total
chicago_sex_by_age <- get_acs(geography = "zcta",
                        year = 2018,
                        table = "B01001") %>% 
                  filter(GEOID %in% zip_code_chicago$zip)
                        
chicago_sex_by_age <- left_join(chicago_sex_by_age, variables_2018[, 1:2], by = "variable")
chicago_sex_by_age <- chicago_sex_by_age %>% filter(str_count(label, "!!") == 3)

chicago_sex_by_age$label <- str_remove(chicago_sex_by_age$label, "Estimate!!Total!!")

chicago_sex_by_age <- separate(chicago_sex_by_age,
                    label,
                    sep = "!!",
                    into = c("Sex", "Age"))

chicago_sex_by_age$Sex <- as.factor(chicago_sex_by_age$Sex)
chicago_sex_by_age$Age <- as.factor(chicago_sex_by_age$Age)

chicago_sex_by_age_2 <- chicago_sex_by_age %>% 
  arrange(GEOID) %>% 
  group_by(GEOID) %>% 
  mutate(zip_pop = sum(estimate)) %>% 
  group_by(GEOID, Sex) %>% 
  mutate(prop_sex = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Age) %>% 
  mutate(prop_age = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Sex, Age) %>% 
  mutate(prop_sex_age = sum(estimate)/zip_pop)
```


## Timmy Miller


```{r}
library(tidyverse)
library(tidycensus)

#load Chicago data

chicago_covid <- read_csv("../Data/chicago_zip_positive_cases.csv",
                          col_types = cols(Zip = col_character()))
chicago_covid <- na.omit(chicago_covid)
chicago_covid <- chicago_covid %>% 
  mutate(case_rate = Cases/Population*100000) %>% 
  mutate(pos_rate = Cases/Tested)
zip_code <- read_csv("../Data/zip_county.csv")
zip_code_chicago <- zip_code %>% filter(primary_city == "Chicago",
                                        state == "IL")

```

```{r}
#citizenship by age and nativity and citizenship

#create variables_2018 set from 5 year ACS
variables_2018 <- load_variables(2018, "acs5", cache = TRUE) %>%
 rename(variable = name)
# create sex_by_age_by_nativity_and_citizenship_status
sex_by_age_by_nativity_and_citizenship_status<- 
  left_join((get_acs(geography="zcta", table="B05003")), variables_2018, by="variable")

#select Chicago ZIPs
sex_by_age_by_nativity_and_citizenship_status<-
  filter(sex_by_age_by_nativity_and_citizenship_status, GEOID %in% 60601:60827)

#remove unneeded !s

sex_by_age_by_nativity_and_citizenship_status$label <- 
  as_factor(str_replace(sex_by_age_by_nativity_and_citizenship_status$label, ".*!!(.*)", "\\1"))

#remove unneeded rows
sex_by_age_by_nativity_and_citizenship_status <- sex_by_age_by_nativity_and_citizenship_status %>%
  filter(!label %in% c("Total", "Naturalized U.S. citizen", "Not a U.S. citizen"))



#rename variables

sex_by_age_by_nativity_and_citizenship_status$variable<-
  str_replace_all(sex_by_age_by_nativity_and_citizenship_status$variable, 
                  "B05003_002", "total males" )

sex_by_age_by_nativity_and_citizenship_status$variable<-
  str_replace_all(sex_by_age_by_nativity_and_citizenship_status$variable,
                  "B05003_003", "males under 18" )

sex_by_age_by_nativity_and_citizenship_status$variable<-
   str_replace_all(sex_by_age_by_nativity_and_citizenship_status$variable, 
                   "B05003_004", "native males under 18" )

sex_by_age_by_nativity_and_citizenship_status$variable<-
    str_replace_all(sex_by_age_by_nativity_and_citizenship_status$variable,
                    "B05003_005", "foreign-born males under 18" )

sex_by_age_by_nativity_and_citizenship_status$variable<-
   str_replace_all(sex_by_age_by_nativity_and_citizenship_status$variable, 
                   "B05003_008", "males 18 years and over" )

sex_by_age_by_nativity_and_citizenship_status$variable<-
  str_replace_all(sex_by_age_by_nativity_and_citizenship_status$variable, 
                  "B05003_009", "native males 18 years and over" )

sex_by_age_by_nativity_and_citizenship_status$variable<-
   str_replace_all(sex_by_age_by_nativity_and_citizenship_status$variable,
                      "B05003_010", "foreign-born males 18 years and over" )

sex_by_age_by_nativity_and_citizenship_status$variable<-
  str_replace_all(sex_by_age_by_nativity_and_citizenship_status$variable,
                  "B05003_013", "total females" )

sex_by_age_by_nativity_and_citizenship_status$variable<-
  str_replace_all(sex_by_age_by_nativity_and_citizenship_status$variable,
                  "B05003_014", "females under 18" )

sex_by_age_by_nativity_and_citizenship_status$variable<-
  str_replace_all(sex_by_age_by_nativity_and_citizenship_status$variable,
                  "B05003_015", "native females under 18" )

sex_by_age_by_nativity_and_citizenship_status$variable<-
  str_replace_all(sex_by_age_by_nativity_and_citizenship_status$variable,
                  "B05003_016", "foreign-born females under 18" )

sex_by_age_by_nativity_and_citizenship_status$variable<-
  str_replace_all(sex_by_age_by_nativity_and_citizenship_status$variable,
                  "B05003_019", "females 18 and over" )

sex_by_age_by_nativity_and_citizenship_status$variable<-
  str_replace_all(sex_by_age_by_nativity_and_citizenship_status$variable,
                  "B05003_020", "native females 18 and over" )

sex_by_age_by_nativity_and_citizenship_status$variable<-
  str_replace_all(sex_by_age_by_nativity_and_citizenship_status$variable,
                  "B05003_021", "foreign-born females 18 years and over" )

#left join Covid data

sex_by_age_by_nativity_and_citizenship_status<- 
  left_join(sex_by_age_by_nativity_and_citizenship_status, chicago_covid, by=c("GEOID"="Zip"))

```


```{r}
#ancestry


ancestry<-left_join((get_acs(geography="zcta", table="B04006")), variables_2018, by="variable")

ancestry$label<- as_factor(str_replace(ancestry$label, ".*!!(.*)", "\\1"))

ancestry<-filter(ancestry, label!="Total")

ancestry<- filter(ancestry, GEOID %in% 60601:60827)



ancestry_2 <- ancestry %>% 
  arrange(GEOID) %>% 
  group_by(GEOID) %>% 
  mutate(zip_pop = sum(estimate)) %>% 
  group_by(GEOID, label) %>% 
  mutate(prop_anc = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, label) 

ancestry<- left_join(ancestry, chicago_covid, by=c("GEOID"="Zip"))

```

```{r}
#health insurance by type 

HI_type_orig<-left_join(
  (get_acs(geography="zcta", table="B27010")), variables_2018, by="variable") %>% 
  filter(GEOID %in% zip_code_chicago$zip)

HI_type_final<-HI_type_orig%>%filter(str_count(label, "!!") >=3, 
                                     !str_detect(label, "of health insurance coverage$"))
HI_type_final$label<-str_remove(HI_type_final$label, "Estimate!!Total!!")


HI_type_final <- separate(HI_type_final,
                      label,
                      sep = "!!",
                      into = c( "Age Group", "Number_HI_polcies", "HI_Type"))

HI_type_final<- HI_type_final  %>% 
  arrange(GEOID) %>% 
  group_by(GEOID) %>% 
  mutate(zip_pop = sum(estimate)) %>% 
  group_by(GEOID, variable) %>% 
  mutate(prop_HItype = sum(estimate)/zip_pop)

```
