---
title: "COVID Impact on Chicago Service Workers-EDA"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("functions.R")
library(tidycensus)
library(tidyverse)
zip_code <- read_csv("../Data/zip_county.csv")
zip_code_chicago <- zip_code %>% filter(primary_city == "Chicago",
                                        state == "IL")
variables_2018 <- load_variables(2018, "acs5", cache = TRUE) %>%
  rename(variable = name)
state_of_interest <- ("IL")
```

## Maya Frederick

Sex by occupation and median earnings
```{r}
chicago_occ1 <- get_acs(geography = "zcta",
                        year = 2018,
                        table = "B24012") %>% 
                  filter(GEOID %in% zip_code_chicago$zip,
                         !variable %in% c("B24012_001"))
chicago_occ1 <- left_join(chicago_occ1, variables_2018[, 1:2], by = "variable")

chicago_occ1 <- chicago_occ1 %>% filter(str_count(label, "!!") == 3)
chicago_occ1$label <- str_remove(chicago_occ1$label, "Estimate!!Total!!")

chicago_occ1 <- separate(chicago_occ1,
                    label,
                    sep = "!!",
                    into = c("Sex", "Occupation"))

```

```{r}
chicago_occ2 <- chicago_occ1 %>% 
  arrange(GEOID) %>% 
  group_by(GEOID) %>% 
  mutate(zip_pop = sum(estimate)) %>% 
  group_by(GEOID, Sex) %>% 
  mutate(prop_sex = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Occupation) %>% 
  mutate(prop_occ = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Sex, Occupation) %>% 
  mutate(prop_sex_occ = sum(estimate)/zip_pop) 
```

Sex by age and citizenship status
```{r}
chicago_citizen <- get_acs(geography = "zcta",
                        year = 2018,
                        table = "B05003") %>% 
                  filter(GEOID %in% zip_code_chicago$zip,
                         !variable %in% c("B05003_001"))
chicago_citizen <- left_join(chicago_citizen, variables_2018[, 1:2], by = "variable")

chicago_citizen <- chicago_citizen %>% filter(str_count(label, "!!") >= 4)
chicago_citizen$label <- str_remove(chicago_citizen$label, "Estimate!!Total!!") 

chicago_citizen <- chicago_citizen %>% filter(!str_detect(label,"Foreign born$"))
chicago_citizen$label <- str_remove(chicago_citizen$label, "Foreign born!!") 

# Created another column because of the fact that some of the citizens only had 3 "!!"'s and some had 4. 
# I just need it to help determine the citizenship status, I delete it later. 
chicago_citizen <- separate(chicago_citizen,
                    label,
                    sep = "!!",
                    into = c("Sex", "Age", "Citizen"))

chicago_citizen$Citizen <- if_else(
  chicago_citizen$Citizen == "Not a U.S. citizen", "No", "Yes")
```

### Dr. Weber's Code

The following code will calculate the proportion of the ZIP code populations that fit into each category. We always need to group by GEOID since we want these numbers per ZIP code. Next, we calculate the total ZIP code population. After that, we do a series of `group_by()`, `mutate()` commands to be able to calculate the proportions for each categorical breakdown. Note the naming conventions for the new columns. Also note that I've created a new data frame to house these proportions as to not mess up the original data pulled from the ACS. You should do this for all possible one-way, two-way, three-way, etc. factorial combinations of the categories (e.g., Sex, Age, Citizen, Sex-Age, Sex-Citizen, Age-Citizen, Sex-Age-Citizen). Also note the algorithmic nature of constructing the factorial combinations. 

```{r}
chicago_citizen_2 <- chicago_citizen %>% 
  arrange(GEOID) %>% 
  group_by(GEOID) %>% 
  mutate(zip_pop = sum(estimate)) %>% 
  group_by(GEOID, Sex) %>% 
  mutate(prop_sex = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Age) %>% 
  mutate(prop_age = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Citizen) %>% 
  mutate(prop_cit = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Sex, Age) %>% 
  mutate(prop_sex_age = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Sex, Citizen) %>% 
  mutate(prop_sex_cit = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Age, Citizen) %>% 
  mutate(prop_age_cit = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Sex, Age, Citizen) %>% 
  mutate(prop_sex_age_cit = sum(estimate)/zip_pop)
```

## Ethan Morlock
```{r}
# Sex by age (Hispanic or Latino)
chicago_sex_age <- get_acs(geography = "zcta",
                                   year = 2018,
                                   table = "B01001I") %>% 
                              filter(GEOID %in% zip_code_chicago$zip,
                                     !variable %in% c("B01001I_001", "B01001I_002", "B01001I_017"))
chicago_sex_age <- left_join(chicago_sex_age, variables_2018[, 1:2], by = "variable")
chicago_sex_age$label <- str_remove(chicago_sex_age$label, "Estimate!!Total!!")
chicago_sex_age <- separate(chicago_sex_age,
                    label,
                    sep = "!!",
                    into = c("Sex", "Age"))
chicago_sex_age$Sex <- as_factor(chicago_sex_age$Sex)
chicago_sex_age$Age <- as_factor(chicago_sex_age$Age)
write_csv(chicago_sex_age, "../Data/chicago_sex_age.csv")

chicago_sex_age_2 <- chicago_sex_age %>% 
  arrange(GEOID) %>% 
  group_by(GEOID) %>% 
  mutate(zip_pop = sum(estimate)) %>% 
  group_by(GEOID, Sex) %>% 
  mutate(prop_sex = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Age) %>% 
  mutate(prop_age = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Sex, Age) %>% 
  mutate(prop_sex_age = sum(estimate)/zip_pop) 
write_csv(chicago_sex_age_2, "../Data/chicago_sex_age_2.csv")
```

```{r}
# Health insurance coverage status by sex by age 
chicago_HI <- get_acs(geography = "zcta",
                   year = 2018,
                   table = "B27001") %>% 
              filter(GEOID %in% zip_code_chicago$zip,
                     !variable %in% c("B27001_001", "B27001_002", "B27001_003", "B27001_006", "B27001_009", "B27001_012",
                                      "B27001_015", "B27001_018", "B27001_021", "B27001_024", "B27001_027", "B27001_030", "B27001_031",
                                      "B27001_034", "B27001_037", "B27001_040", "B27001_043", "B27001_046", "B27001_049", "B27001_052",
                                      "B27001_055"))
chicago_HI <- left_join(chicago_HI, variables_2018[, 1:2], by = "variable")
chicago_HI$label <- str_remove(chicago_HI$label, "Estimate!!Total!!")
chicago_HI <- separate(chicago_HI,
                    label,
                    sep = "!!",
                    into = c("Sex", "Age", "HI_coverage"))
chicago_HI$HI_coverage <- if_else(chicago_HI$HI_coverage == "With health insurance coverage", "Yes", "No")
chicago_HI$Sex <- as_factor(chicago_HI$Sex)
chicago_HI$Age <- as_factor(chicago_HI$Age)
chicago_HI$HI_coverage <- as_factor(chicago_HI$HI_coverage)
write_csv(chicago_HI, "../Data/chicago_HI.csv")

chicago_HI_2 <- chicago_HI %>% 
  arrange(GEOID) %>% 
  group_by(GEOID) %>% 
  mutate(zip_pop = sum(estimate)) %>% 
  group_by(GEOID, Sex) %>% 
  mutate(prop_sex = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Age) %>% 
  mutate(prop_age = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, HI_coverage) %>% 
  mutate(prop_HI_cov = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Sex, Age) %>% 
  mutate(prop_sex_age = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Sex, HI_coverage) %>% 
  mutate(prop_sex_HI_cov = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Age, HI_coverage) %>% 
  mutate(prop_age_HI_cov = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Sex, Age, HI_coverage) %>% 
  mutate(prop_sex_age_HI_cov = sum(estimate)/zip_pop)
write_csv(chicago_HI_2, "../Data/chicago_HI_2.csv")
```

```{r}
# Race (Hispanic or Latino)
chicago_race <- get_acs(geography = "zcta",
                     year = 2018,
                     table = "B03002") %>% 
                filter(GEOID %in% zip_code_chicago$zip,
                       variable %in% c("B03002_010", "B03002_011", "B03002_020", "B03002_021"))
chicago_race <- left_join(chicago_race, variables_2018[, 1:2], by = "variable")
chicago_race$label <- str_remove(chicago_race$label, "Estimate!!Total!!")
chicago_race <- separate(chicago_race,
                    label,
                    sep = "!!",
                    into = c("Hispanic_or_Latino", "Two_or_more", "Including_other_race"))
chicago_race$Hispanic_or_Latino <- if_else(chicago_race$Hispanic_or_Latino == "Not Hispanic or Latino", "No", "Yes")
chicago_race$Including_other_race <- if_else(chicago_race$Including_other_race == "Two races including Some other race", "Including", "Excluding")
chicago_race$Hispanic_or_Latino <- as_factor(chicago_race$Hispanic_or_Latino)
chicago_race$Two_or_more <- as_factor(chicago_race$Two_or_more)
chicago_race$Including_other_race <- as_factor(chicago_race$Including_other_race)
write_csv(chicago_race, "../Data/chicago_race.csv")

chicago_race_2 <- chicago_race %>% 
  arrange(GEOID) %>% 
  group_by(GEOID) %>% 
  mutate(zip_pop = sum(estimate)) %>% 
  group_by(GEOID, Hispanic_or_Latino) %>% 
  mutate(prop_His_Lat = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Two_or_more) %>% 
  mutate(prop_Two_more = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Including_other_race) %>% 
  mutate(prop_incl_other = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Hispanic_or_Latino, Two_or_more) %>% 
  mutate(prop_His_Lat_Two_more = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Hispanic_or_Latino, Including_other_race) %>% 
  mutate(prop_His_Lat_incl_other = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Two_or_more, Including_other_race) %>% 
  mutate(prop_Two_more_incl_other = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Hispanic_or_Latino, Two_or_more, Including_other_race) %>% 
  mutate(prop_His_Lat_Two_more_incl_other = sum(estimate)/zip_pop)
write_csv(chicago_race_2, "../Data/chicago_race_2.csv")
```


## Pearl Muensterman
```{r}
#Sex by Industry
chicago_sex_by_ind <- get_acs(geography = "zcta",
                        year = 2018,
                        table = "B24032") %>% 
                  filter(GEOID %in% zip_code_chicago$zip,
                         !variable %in% c("B24032_001", "B24032_003", "B24032_004", "B24032_010", "B24032_011", "B24032_014", "B24032_015","B24032_017", "B24032_018", "B24032_019", "B24032_021", "B24032_022", "B24032_023", "B24032_028", "B24032_030", "B24032_031", "B24032_037", "B24032_038", "B24032_041", "B24032_042", "B24032_044", "B24032_045", "B24032_046", "B24032_048", "B24032_049", "B24032_050"))
chicago_sex_by_ind <- left_join(chicago_sex_by_ind, variables_2018[, 1:2], by = "variable")

chicago_sex_by_ind$label <- str_remove(chicago_sex_by_ind$label, "Estimate!!")
chicago_sex_by_ind$label <- str_remove(chicago_sex_by_ind$label, "Arts, entertainment, and recreation, and accommodation and food services!!")

chicago_sex_by_ind <- separate(chicago_sex_by_ind,
                    label,
                    sep = "!!",
                    into = c("Sex", "Industry"))

chicago_sex_by_ind$Sex <- as.factor(chicago_sex_by_ind$Sex)
chicago_sex_by_ind$Industry <- as.factor(chicago_sex_by_ind$Industry)
  

chicago_sex_by_ind <- chicago_sex_by_ind %>% mutate(Service_Worker = chicago_sex_by_ind$Industry)

chicago_sex_by_ind$Service_Worker <- if_else((chicago_sex_by_ind$Service_Worker == "Construction" | chicago_sex_by_ind$Service_Worker == "Manufacturing" | chicago_sex_by_ind$Service_Worker == "Retail trade" | chicago_sex_by_ind$Service_Worker == "Transportation and warehousing, and utilities" | chicago_sex_by_ind$Service_Worker == "Accommodation and food services"), "Yes", "No")

chicago_sex_by_ind <- subset(chicago_sex_by_ind, select = -Industry)

chicago_sex_by_ind_2 <- chicago_sex_by_ind %>% 
  arrange(GEOID) %>% 
  group_by(GEOID) %>% 
  mutate(zip_pop = sum(estimate, is.na = TRUE)) %>% 
  group_by(GEOID, Sex) %>% 
  mutate(prop_sex = sum(estimate, is.na = TRUE)/zip_pop) %>% 
  group_by(GEOID, Service_Worker) %>% 
  mutate(prop_service = sum(estimate, is.na = TRUE)/zip_pop) %>% 
  group_by(GEOID, Sex, Service_Worker) %>% 
  mutate(prop_sex_service = sum(estimate, is.na = TRUE)/zip_pop)
```


```{r}
#Sex by Age Total
chicago_sex_by_age <- get_acs(geography = "zcta",
                        year = 2018,
                        table = "B01001") %>% 
                  filter(GEOID %in% zip_code_chicago$zip)
                        
chicago_sex_by_age <- left_join(chicago_sex_by_age, variables_2018[, 1:2], by = "variable")
chicago_sex_by_age <- chicago_sex_by_age %>% filter(str_count(label, "!!") == 3)

chicago_sex_by_age$label <- str_remove(chicago_sex_by_age$label, "Estimate!!Total!!")

chicago_sex_by_age <- separate(chicago_sex_by_age,
                    label,
                    sep = "!!",
                    into = c("Sex", "Age"))

chicago_sex_by_age$Sex <- as.factor(chicago_sex_by_age$Sex)
chicago_sex_by_age$Age <- as.factor(chicago_sex_by_age$Age)

chicago_sex_by_age <- chicago_sex_by_age %>% 
  group_by(GEOID, Age) %>% 
  summarize("Under 5 to 17" = "Under 5 years" + "5 to 9 years" +
                              "10 to 14 years" + "15 to 17 years",
            "18 to 34" = "18 and 19 years" + "20 years" + 
                         "21 years" + "22 to 24 years" + 
                         "25 to 29 years" + "30 to 34 years",
            "35 to 64" = "35 to 39 years" + "40 to 44 years" + 
                         "45 to 49 years" + "50 to 54 years" +
                         "55 to 59 years" + "60 and 61 years" + 
                                            "62 to 64 years",
            "65 and Older" = "65 and 66 years" + "67 to 69 years" +
                             "70 to 74 years" + "75 to 79 years" +
                             "80 to 84 years" + "85 years and over")

chicago_sex_by_age_2 <- chicago_sex_by_age %>% 
  arrange(GEOID) %>% 
  group_by(GEOID) %>% 
  mutate(zip_pop = sum(estimate)) %>% 
  group_by(GEOID, Sex) %>% 
  mutate(prop_sex = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Age) %>% 
  mutate(prop_age = sum(estimate)/zip_pop) %>% 
  group_by(GEOID, Sex, Age) %>% 
  mutate(prop_sex_age = sum(estimate)/zip_pop)
```


## Timmy Miller


