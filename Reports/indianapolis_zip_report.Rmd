---
title: 'COVID-19: A Midwestern Reporting Project of WNIN and the University of Evansville'
author: "Indianapolis Zip Code Analysis"
date: "9/4/2020"
output: html_document
urlcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidycensus)
library(tidyverse)
library(readxl)
library(sf)
library(leaflet)
library(stringr)
library(tigris)

options(tigris_use_cache = TRUE)

zip_code <- read_csv("../Data/zip_county.csv")
zip_code_indy <- zip_code %>% filter(primary_city == "Indianapolis",
                                     state == "IN")
# Indy COVID data
indiana_cases_by_zip <- read_excel("../Data/indiana_cases_by_zip.xlsx")
indiana_cases_by_zip <- indiana_cases_by_zip %>% filter(ZIP_CD %in% zip_code_indy$zip)
indiana_cases_by_zip$PATIENT_COUNT <- as.numeric(indiana_cases_by_zip$PATIENT_COUNT)
indiana_cases_by_zip$POPULATION <- as.numeric(indiana_cases_by_zip$POPULATION)
indiana_cases_by_zip$ZIP_CD <- as.numeric(indiana_cases_by_zip$ZIP_CD)
indiana_cases_by_zip <- indiana_cases_by_zip %>% 
  mutate(case_rate = PATIENT_COUNT/POPULATION) 

# Variables from the ACS survey
variables_2018 <- load_variables(2018, "acs5", cache = TRUE) %>%
  rename(variable = name)

```

## Background

The goal of this analysis is to find any connections, if they exist, between demographic data and the outbreak of COVID-19 in the city of Indianapolis Demographic data was obtained from the Census Bureau through their 5-year American Community Survey published in 2018 (the most recent 5-year data available). COVID-19 case numbers were obtained from the Indiana State Department of Health. ([https://hub.mph.in.gov/dataset/covid-19-cases-by-zip])

During the process of exploratory data analysis between demographic data and COVID-19 data in each zip code in Indianapolis, we find that with income there not a correlation between having a poorer income and a higher rate of infection. Additionally, we find that when looking at race, zip codes that are majority African American have just a slightly higher case rate than zip codes that consist of majority White. We find that there is not a correlation between having a higher age and case rate, in fact in this case, there was a correlation between the zip codes with a lower proportion of people aged 75 and up and a higher case rate. We also investigated variables such as citizenship vs non-citizenship, essential vs non-essential work occupation, public transportation, and the Gini Index. Public transportation had the highest correlation with case rate with a correlation of 0.48.  

## Analysis

### Income
```{r, echo=FALSE}
indy_income <- get_acs(geography = "zcta",
                        table = "B19101",
                        geometry = TRUE) %>% 
  filter(GEOID %in% zip_code_indy$zip,
         !variable %in% c("B19101_001"))

indy_income <- left_join(indy_income, variables_2018[, 1:2], by = "variable")

indy_income$label <- as_factor(str_replace(indy_income$label, ".*!!(.*)", "\\1"))

indy_income_six_figure <- indy_income %>% 
  group_by(GEOID) %>% 
  mutate(n = sum(estimate),
         prop = estimate/n) %>% 
  filter(label %in% c("$200,000 or more",
                      "$150,000 to $199,999",
                      "$125,000 to $149,999",
                      "$100,000 to $124,999")) %>% 
  mutate(prop_100K = sum(prop)) %>% 
  select(GEOID, prop_100K) %>% 
  distinct(GEOID, prop_100K)

lvls <- indy_income_six_figure %>% 
  arrange(prop_100K) %>% 
  pull(GEOID)

indy_income$GEOID <- as.numeric(indy_income$GEOID)
indy_income <- left_join(indy_income, indiana_cases_by_zip, by = c("GEOID" = "ZIP_CD"))
```

We look at the income data in increments designated by the Census Bureau. We calculated the proportion of people making over \$100,000 to order the zip codes on the $x$-axis in the following graph. 

```{r, echo=FALSE, fig.width=12}
ggplot(indy_income) +
  geom_col(aes(factor(GEOID, levels = lvls), estimate, fill = label),
           position = "fill") +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1))+
  labs(title = "Income Distribution for Each Indianapolis Zip Code",
       x = "Zip Code",
       y = "Proportion", 
       fill = "Income Level")
```

We can compare zip codes with the case rate (per 100000) of COVID in the same zip codes.
```{r,echo=FALSE}
pal <- colorNumeric(palette = "viridis", domain = indy_income$case_rate)
indy_income %>% 
  st_transform(crs = "+init=epsg:4326") %>% 
  leaflet(width = "100%") %>% 
  addProviderTiles(provider = "CartoDB.Positron") %>% 
  addPolygons(popup = str_c("<strong>", indy_income$GEOID,
                            "</strong><br /> Case Rate ", indy_income$case_rate),
              stroke = FALSE,
              smoothFactor = 0,
              fillOpacity = 0.7,
              color = ~ pal(case_rate)) %>% 
  addLegend("bottomright",
            pal = pal,
            values = ~ case_rate,
            title = "Case Rate (per 100000)",
            opacity = 1)
```

```{r,echo=FALSE}
indy_income_six_figure$GEOID <- as.numeric(indy_income_six_figure$GEOID)
indy_income_cor <- left_join(indy_income_six_figure, 
                             indiana_cases_by_zip, by = c("GEOID"="ZIP_CD"))
```

First, we notice that there is one zip code that does not have any COVID-19 data. This zip code was suppressed. When we looked into that zip code we found that it is a popular zip code with a population of around 14,000. However, some zip codes in the COVID-19 data were suppressed, which means that it is not being reported. Having the information for that zip code could potential slightly change the results of our analysis. 
There does not seem to be any sort of correlation, i.e., the poorer the zip code the more likely to have a higher rate of infection. However, we can verify that there is no correlation by running a correlation test between the case rate and the proportion of the population that makes over \$100,000. We get a statistically non-significant ($p=$ `r cor.test(indy_income_cor$prop_100K, indy_income_cor$case_rate, use = "complete.obs")$p.value`) correlation value of `r cor.test(indy_income_cor$prop_100K, indy_income_cor$case_rate, use = "complete.obs")$estimate`. This verifies that there is not a negative correlation between case rates and higher incomes. 

Additionally, from the graph above you can see that one zip code has a much higher case rate than any of the other zip codes. That zip code happens to be 46204 and it is right in the middle of Indianapolis. This zip code has a case rate of 5.9% while the average case rate for Indianapolis zip codes is 1.85%. So 46204 has over double the average case rate for zip codes in Indianapolis. This zip code only has a population of 5,125 people which is the second to last least populous zip code. 
While not a lot of people live there, since it is right in the middle of Indianapolis there are many bars, restaurants, stores, etc., making that zip code very crowded and easy to contract the virus. Which is a possible reason why the case rate of that zip code is so high. 

## Race 

When looking at the distribution of race across Indianapolis. It can be seen that the greater majority of Indianapolis is white. 
```{r,echo=FALSE, fig.width=12}
indy_race <- get_acs(geography = "zcta",
                        year = 2018,
                        table = "B02001") %>% 
  filter(GEOID %in% zip_code_indy$zip,
         !variable %in% c("B02001_001"))
indy_race <- left_join(indy_race, variables_2018[, 1:2], by = "variable")
indy_race$label <- as_factor(str_replace(indy_race$label, ".*!!(.*)", "\\1"))

indy_black <- indy_race %>% 
  group_by(GEOID) %>% 
  mutate(n = sum(estimate),
         prop = estimate/n) %>% 
  filter(label %in% c("Black or African American alone")) %>% 
  mutate(prop_black = sum(prop)) %>% 
  select(GEOID, prop_black) %>% 
  distinct(GEOID, prop_black)

lvls6 <- indy_black %>% 
  arrange(prop_black) %>% 
  pull(GEOID)

ggplot(indy_race) +
  geom_col(aes(factor(GEOID, levels = lvls6), estimate, fill = label),
           position = "fill") +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1))+
  labs(title = "Race Distribution for Each Indianapolis Zip Code",
       x = "Zip Code",
       y = "Proportion", 
       fill = "Race")

indy_black$GEOID <- as.numeric(indy_black$GEOID)
```

It can be seen that the next highest race in Indianapolis is African American. We can get the average case rate for zip codes that are majority of both races to see how they compare to each other. The average case rate for zip codes that consist of greater than 50% white people is 1.79% while the average case rate for zip codes that consists of greater than 50% African American people is 1.83%. They African American case rate is just a little bit higher than the white case rate. The overall average case rate among all zip codes is 1.85% so those averages are a little bit lower than the overall average. When testing for correlation between the African American proportion and case rate we find a positive correlation of 0.22. This indicates that the more African American population there is in a zip code, the higher the case rate is likely to be. 

## Age
```{r,echo=FALSE, fig.width=12}
indy_sex <- get_acs(geography = "zcta",
                       year = 2018,
                       table = "B01001") %>% 
  filter(GEOID %in% zip_code_indy$zip,
         !variable %in% c("B01001_001"))
indy_sex <- left_join(indy_sex, variables_2018[, 1:2], by = "variable")
indy_sex$label <- as_factor(str_replace(indy_sex$label, ".*!!(.*)", "\\1"))

indy_over_sixty5 <- indy_sex %>% 
  group_by(GEOID) %>% 
  mutate(n = sum(estimate),
         prop = estimate/n) %>% 
  filter(label %in% c("65 and 66 years",
                      "67 to 69 years",
                      "70 to 74 years",
                      "75 to 79 years",
                      "80 to 84 years",
                      "85 years and over")) %>% 
  mutate(prop_65 = sum(prop)) %>% 
  select(GEOID, prop_65) %>% 
  distinct(GEOID, prop_65)

lvls5 <- indy_over_sixty5 %>% 
  arrange(prop_65) %>% 
  pull(GEOID)

ggplot(indy_sex) +
  geom_col(aes(factor(GEOID, levels = lvls5), estimate, fill = label),
           position = "fill") +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1))+
  labs(title = "Age Distribution for Each Indianapolis Zip Code",
       x = "Zip Code",
       y = "Proportion", 
       fill = "Age")
```

When looking at age demographics we focused on age 60 and up due to the fact that COVID was known to be more deadly to people with more comorbidities and the older population has more comorbidities than the younger population. When testing for any correlation between the population of the age of 65 and the case rate of COVID, we get a negative correlation of -0.35. This means that the zip codes that contain a higher proportion of people over the age of 60 have a lower case rate.  


## Citizenship vs. Non-citizenship 
We can look at the proportion of citizens and non citizens for each zip code in Indianapolis. 
```{r,echo=FALSE, fig.width=12}
indy_citizen <- get_acs(geography = "zcta",
                           year = 2018,
                           table = "B05001") %>% 
  filter(GEOID %in% zip_code_indy$zip,
         !variable %in% c("B05001_001"))
indy_citizen <- left_join(indy_citizen, variables_2018[, 1:2], by = "variable")
indy_citizen$label <- as_factor(str_replace(indy_citizen$label, ".*!!(.*)", "\\1"))

indy_not_citizen <- indy_citizen %>% 
  group_by(GEOID) %>% 
  mutate(n = sum(estimate),
         prop = estimate/n) %>% 
  filter(label %in% c("Not a U.S. citizen")) %>% 
  mutate(prop_not_citizen = sum(prop)) %>% 
  select(GEOID, prop_not_citizen) %>% 
  distinct(GEOID, prop_not_citizen)

lvls7 <- indy_not_citizen %>% 
  arrange(prop_not_citizen) %>% 
  pull(GEOID)

ggplot(indy_citizen) +
  geom_col(aes(factor(GEOID, levels = lvls7), estimate, fill = label),
           position = "fill") +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1))+
  labs(title = "Citizen Distribution for Each Indianapolis Zip Code",
       x = "Zip Code",
       y = "Proportion", 
       fill = "Citizenship Status")
```

While there is not a whole lot of zip codes that contain a high amount of non-citizens, we still tested for correlation between the proportion of non-citizens and the case rate. The results yielded a positive correlation of 0.25. Meaning that the zip codes with a higher proportion of non-citizens were more likely to have a higher case rate. 

## Essential vs Non-essential workers
We were able to view the proportion of essential workers: 
```{r,echo=FALSE, fig.width=12}
indy_occ <- get_acs(geography = "zcta",
                    year = 2018,
                    table = "C24060") %>% 
  filter(GEOID %in% zip_code_indy$zip,
         !variable %in% c("C24060_001"))
indy_occ <- left_join(indy_occ, variables_2018[, 1:2], by = "variable")
indy_occ$label <- as_factor(str_replace(indy_occ$label, ".*!!(.*)", "\\1"))

indy_occ_essential <- indy_occ %>% 
  group_by(GEOID) %>% 
  mutate(n = sum(estimate),
         prop = estimate/n) %>% 
  filter(label %in% c("Natural resources, construction, and maintenance occupations",
                      "Production, transportation, and material moving occupations")) %>% 
  mutate(prop_essential = sum(prop)) %>% 
  select(GEOID, prop_essential) %>% 
  distinct(GEOID, prop_essential)

lvls3 <- indy_occ_essential %>% 
  arrange(prop_essential) %>% 
  pull(GEOID)

ggplot(indy_occ) +
  geom_col(aes(factor(GEOID, levels = lvls3), estimate, fill = label),
           position = "fill") +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1))+
  labs(title = "Occupation Distribution for Each Indianapolis Zip Code",
       x = "Zip Code",
       y = "Proportion", 
       fill = "Occupation Category")
```

and non-essential workers:

```{r,echo=FALSE,, fig.width=12}
indy_occ_nonessential <- indy_occ %>% 
  group_by(GEOID) %>% 
  mutate(n = sum(estimate),
         prop = estimate/n) %>% 
  filter(label %in% c("Management, business, science, and arts occupations",
                      "Service occupations",
                      "Sales and office occupations",
                      "Employee of private company workers")) %>% 
  mutate(prop_nonessential = sum(prop)) %>% 
  select(GEOID, prop_nonessential) %>% 
  distinct(GEOID, prop_nonessential)

lvls4 <- indy_occ_nonessential %>% 
  arrange(prop_nonessential) %>% 
  pull(GEOID)

ggplot(indy_occ) +
  geom_col(aes(factor(GEOID, levels = lvls4), estimate, fill = label),
           position = "fill") +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1))+
  labs(title = "Occupation Distribution for Each Indianapolis Zip Code",
       x = "Zip Code",
       y = "Proportion", 
       fill = "Occupation Category")
```

We tested for correlation between both proportions of essential and non-essential workers and case rate. The correlation test results were close to 0. Indicating that essential vs non-essential proportions do not impact the case rate. 

## Public Transportation
When looking into the distribution of public transportation we can see the proportions (I used "Public transportation (excluding taxicab)", "Bus or trolley bus", "Streetcar or trolley car (carro publico in Puerto Rico)", "Subway or elevated", and "Railroad" all as the variable public transportation).
```{r,echo=FALSE, fig.width=12}
indy_trans <- get_acs(geography = "zcta",
                         year = 2018,
                         table = "B08301") %>% 
  filter(GEOID %in% zip_code_indy$zip,
         !variable %in% c("B08301_001"))
indy_trans <- left_join(indy_trans, variables_2018[, 1:2], by = "variable")
indy_trans$label <- as_factor(str_replace(indy_trans$label, ".*!!(.*)", "\\1"))

indy_public_trans <- indy_trans %>% 
  group_by(GEOID) %>% 
  mutate(n = sum(estimate),
         prop = estimate/n) %>% 
  filter(label %in% c("Public transportation (excluding taxicab)",
                      "Bus or trolley bus",
                      "Streetcar or trolley car (carro publico in Puerto Rico)",
                      "Subway or elevated",
                      "Railroad")) %>% 
  mutate(prop_public = sum(prop)) %>% 
  select(GEOID, prop_public) %>% 
  distinct(GEOID, prop_public)

lvls8 <- indy_public_trans %>% 
  arrange(prop_public) %>% 
  pull(GEOID)

ggplot(indy_trans) +
  geom_col(aes(factor(GEOID, levels = lvls), estimate, fill = label),
           position = "fill") +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1))+
  labs(title = "Transportation Distribution for Each Indianapolis Zip Code",
       x = "Zip Code",
       y = "Proportion", 
       fill = "Means of Transportation")
```

After running a correlation test we get a fairly high correlation value of 0.48. Meaning that as more people use public transportation the higher that zip codes case rate will be. This higher correlation may mean that public transportation in Indianapolis highly impacts the COVID case rate. 
## Gini Index
Next, we looked at the Gini Index. The Gini Index is a coefficient that represents the income inequality or wealth inequality. A perfect Gini Index coefficient would be 0. So, the higher, the worse. When looking at the Gini Index values for each zip code in Indianapolis we find that most of the zip codes have fairly high Gini Index coefficients. 
```{r,echo=FALSE, fig.width=12}
indy_gini <- get_acs(geography = "zcta",
                      year = 2018,
                      table = "B19083") %>% 
  filter(GEOID %in% zip_code_indy$zip,
         variable %in% c("B19083_001"))
indy_gini <- left_join(indy_gini, variables_2018[, 1:2], by = "variable")
indy_gini$label <- as_factor(str_replace(indy_gini$label, ".*!!(.*)", "\\1"))

ggplot(indy_gini) +
  geom_col(mapping = aes(x = factor(GEOID), y = estimate)) +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1)) +
  labs(title = "Gini Index Value for Each Indianapolis Zip Code",
       x = "Zip Code",
       y = "Gini Index Value")
```

The highest value is 0.6 and the lowest is only 0.3. When testing for correlation between the COVID case rate and the Gini Index, we got a positive correlation of 0.39. Meaning that the higher the Gini Index value the higher the case rate was likely to be. The correlation value is fairly high given our small range for the Gini Index coefficient. 

## Conclusion
As you can see from exploring the zip code data for demographics and COVID-19 of the city of Indianapolis, we find a couple of interesting things. Lower income does not seem to be related with a higher case rate in Indianapolis. Indianapolis has a nice spread of income so it would make sense as to why income is not correlated with a higher case rate. Additionally, we can see subtle differences in case rates with regards to racial demographics. The zip codes that are majority white have just a little bit lower average case rate than the zip codes that are majority African American. Both averages are actually lower than the overall average for zip codes in Indianapolis. Lastly, when we looked into the age demographic, we focused on the population that was aged 75 or older. We found that there was actually a negative correlation between the older you are and your chances of contracting COVID-19. We also looked at some variables that you might not first think of when thinking about what impacts the COVID case rate. We looked at public transportation, essential vs non-essential workers, citizenship vs non-citizenship, and the Gini Index. We found the highest correlation between public transportation and case rate. 
