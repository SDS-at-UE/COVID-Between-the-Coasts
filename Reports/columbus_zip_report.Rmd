---
title: 'COVID-19: A Midwestern Reporting Project of WNIN and the University of Evansville'
author: "Columbus ZIP Code Analysis"
date: "Analysis performed by Maya Frederick, Timmy Miller, Ethan Morlock, Pearl Muensterman, and Darrin Weber, Ph.D."
output: html_document
urlcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
options(scipen = 999, digits = 6)
library(tidycensus)
library(tidyverse)
library(leaflet)
library(sf)
library(tigris)
library(readxl)
options(tigris_use_cache = TRUE)
variables_2018 <- load_variables(2018, "acs5", cache = TRUE) %>%
  rename(variable = name)
zip_code <- read_csv("../Data/zip_county.csv")
zip_code_col <- zip_code %>% filter(primary_city == "Columbus", state == "OH")
geometry_zip <- read_sf("../Data/All_zips.shp", type = 6)
geometry_zip_col <- filter(geometry_zip, GEOID %in% zip_code_col$zip)
col_covid <- read_excel("../Data/columbus_covid.xlsx")
```

## Background

The goal of this analysis is to find any connections, if they exist, between demographic data and the outbreak of COVID-19 in the city of Columbus. Demographic data was obtained from the Census Bureau through their 5-year American Community Survey published in 2018 (the most recent 5-year data available). COVID-19 case numbers were obtained from the Columbus Public Health Department ([https://public.tableau.com/views/COVID-19OutbreakSummary_15918845768300/COVID19Summaryp3?%3Adisplay_count=y&%3Aorigin=viz_share_link&%3AshowVizHome=no]). 

Throughout the document, we report the $p$-value for several statistical tests. This does nothing more than provide a measure on the amount of evidence we have to suggest statistical significance. The closer the $p$-value is to 0 the stronger the evidence that our measure (correlation most of the time) is different than 0. 

**Conclusions:** First, we looked at the data that was available for COVID from the Columbus Public Health Department. The data was not in exact numbers, instead it was given in ranges. Which is why we had to perform an ANOVA test instead of a normal correlation test. There were no outliers as Columbus had a nice distribution of COVID within the ZIP codes.

We found positive correlations for the income, essential occupations, public transportation, and public transit variables. Meaning those variables had evidence to suggest that they do impact the COVID case rate. The most significant variable that we had was public health insurance. This means that the ZIP codes with a higher proportion of people that had public health insurance indicated a higher COVID case rate. This had a very significant p-value of 0.0003.

## Analysis

### COVID

We first look at the COVID cases by ZIP codes. The city of Columbus reported their data in ranges instead of exact numbers. To be able to conduct analysis we took the average of that particular range for that ZIP code. That is why ZIP codes of the same color have the exact same case rate. Columbus does not seem to have any outliers as there is a nice spread of the COVID case rate. As you can see the more metropolitan areas have a little bit higher case rate which is what is expected. 

```{r}
geometry_zip_col$GEOID <- as.numeric(geometry_zip_col$GEOID)
col_covid_geo <- left_join(col_covid, geometry_zip_col, by = c("ZIP" = "GEOID"))
col_covid_geo <- st_as_sf(col_covid_geo, sf_column_name = "geometry")

pal <- colorNumeric(palette = "viridis", domain = col_covid_geo$average)
col_covid_geo %>% 
  st_transform(crs = "+init=epsg:4326") %>% 
  leaflet(width = "100%") %>% 
  addProviderTiles(provider = "CartoDB.Positron") %>% 
  addPolygons(popup = str_c("<strong>", col_covid_geo$ZIP,
                            "</strong><br /> Case Rate ", signif(col_covid_geo$average, digits = 4)),
              weight = 4,
              smoothFactor = 0,
              fillOpacity = 0.7,
              color = ~ pal(average)) %>% 
  addLegend("bottomright",
            pal = pal,
            values = ~ average,
            title = "Case Rate (per 100000)",
            opacity = 1)
```

### Occupation

During the COVID-19 outbreak in the United States, we were divided into 2 groups based off our occupations: essential and nonessential. Those who were deemed "essential" continued to go to work in the midst of the pandemic. On the other side of the spectrum, those who are known as "nonessential" continued to work from home. We can see how this separation could easily have an influence of cases.

The Census Bureau breaks workers into five categories: Management, business, science and arts; service; sales and office; natural resources, construction, and maintenance; and production, transportation, and material moving. Although these categories undoubtedly may not be clear distinctions between essential and non-essential, we feel a good classification is to put natural resources, construction, and maintenance and production, transportation, material moving as essential and the other three categories as non-essential.

```{r}
col_occ <- get_acs(geography = "zcta",
                     table = "C24060") %>%
  filter(GEOID %in% zip_code_col$zip,
         variable %in% str_c("C24060_00", 2:6))
col_occ <- left_join(col_occ, variables_2018[, 1:2], by = "variable")
col_occ$label <- as_factor(str_replace(col_occ$label, ".*!!(.*)", "\\1"))

col_occ_ess <- col_occ %>%
  group_by(GEOID) %>%
  mutate(n = sum(estimate),
         prop = estimate/n) %>%
  filter(str_detect(label,
                    "(Natural.*)|(Production.*)")) %>%
  mutate(prop_ess = sum(prop)) %>%
  select(GEOID, prop_ess) %>%
  distinct(GEOID, prop_ess)

lvls_col_ess <- col_occ_ess %>%
  arrange(prop_ess) %>%
  pull(GEOID)

ggplot(col_occ) +
  geom_col(aes(factor(GEOID, levels = lvls_col_ess), estimate, fill = label),
           position = "fill") +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1),
        legend.position = "bottom") +
  labs(title = "Occupation Distribution for Each Columbus ZIP Code",
       x = "ZIP Code",
       y = "Proportion of Population",
       fill = "Occupation \nType")
```

Our essential occupations were said to be in two categories: Natural resources, construction, and maintenance; and production, transportation, and material moving. The percentage of the population that has these occupations is not the majority, never reaching above 40\%. Most Columbus residents worked from home with their nonessential jobs. 

```{r}
col_occ_ess$GEOID <- as.numeric(col_occ_ess$GEOID)
col_occ_ess <- left_join(col_occ_ess, col_covid, by = c("GEOID" = "ZIP"))

## ANOVA TEST
ess_lm <- lm(prop_ess ~ as.factor(average), data = col_occ_ess)
```

Our test gives outputs of 0.00974 for our p-value (significant), R^2 equal to 0.39, and correlation of 0.6245. This tells us that there is a moderate correlation between the percentage of the population working "essential" jobs and the rate of COVID cases: as a ZIP code has more essential workers, it also has a higher COVID case rate.

### Citizenship

The Census Bureau provides a distinction between different types of U.S. citizenship (e.g., naturalization, born in U.S., born abroad, etc.). We focus on the simple distinction between being a U.S. citizen and not.

```{r}
col_citizen_clean <- get_acs(geography = "zcta",
                               table = "B05001") %>%
  filter(GEOID %in% zip_code_col$zip,
         variable %in% str_c("B05001_00", 2:6))

col_citizen <- left_join(col_citizen_clean, variables_2018[, 1:2], by = "variable")
col_citizen$label <- as_factor(str_replace(col_citizen$label, ".*!!(.*)", "\\1"))

col_citizen <- col_citizen %>%
  group_by(GEOID) %>%
  mutate(n = sum(estimate),
         prop = estimate/n)

col_citizen_prop_us <- col_citizen %>%
  filter(str_detect(label,
                    "^U.S.")) %>%
  mutate(prop_us_citizen = sum(prop)) %>%
  select(GEOID, prop_us_citizen) %>%
  distinct(GEOID, prop_us_citizen)

lvls_col_citizen <- col_citizen_prop_us %>%
  arrange(prop_us_citizen) %>%
  pull(GEOID)

ggplot(col_citizen) +
  geom_col(aes(factor(GEOID, levels = lvls_col_citizen), estimate, fill = label),
           position = "fill") +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1),
 legend.position = "bottom") +
  labs(title = "Citizenship Distribution for Each Columbus ZIP Code",
       x = "ZIP Code",
       y = "Proportion of Population",
       fill = "Citizenship \nType")
```

The percentage of the population that is U.S. citizens is not less 75\% with an exception of one zipcode where that rate falls slightly. 

```{r}
col_citizen_prop_us$GEOID <- as.numeric(col_citizen_prop_us$GEOID)
col_citizen_prop_us <- left_join(col_citizen_prop_us, col_covid, by = c("GEOID" = "ZIP"))

## ANOVA TEST
citizen_lm <- lm(prop_us_citizen ~ as.factor(average), data = col_citizen_prop_us)
```

We have a slight positive correlation between U.S. citizens and COVID-19 cases. That correlation is 0.1997. With that being said, our p-value is insignificant at 0.894. There seems to be no real relation between these two factors meaning ZIP codes with a higher proportion of U.S citizens seem to not have a higher COVID rate.

### Income
```{r}
col_income <- get_acs(geography = "zcta",
                        table = "B19101") %>% 
  filter(GEOID %in% zip_code_col$zip,
         !variable %in% c("B19101_001"))
col_income <- left_join(col_income, variables_2018[, 1:2], by = "variable")
col_income$label <- as_factor(str_replace(col_income$label, ".*!!(.*)", "\\1"))
geometry_zip_col$GEOID <- as.character(geometry_zip_col$GEOID)
col_income <- left_join(col_income, geometry_zip_col, by = "GEOID")
col_income <- st_as_sf(col_income, sf_column_name = "geometry")
```

We look at the income data in increments designated by the Census Bureau. We calculated the proportion of people making over \$100,000 to order the ZIP codes on the $x$-axis in the following graph. 

```{r}
col_income_six_figure <- col_income %>% 
  group_by(GEOID) %>% 
  mutate(n = sum(estimate),
         prop = estimate/n) %>% 
  filter(label %in% c("$200,000 or more",
                      "$150,000 to $199,999",
                      "$125,000 to $149,999",
                      "$100,000 to $124,999")) %>% 
  mutate(prop_100K = sum(prop)) %>% 
  select(GEOID, prop_100K) %>% 
  distinct(GEOID, prop_100K)

lvls <- col_income_six_figure %>% 
  arrange(prop_100K) %>% 
  pull(GEOID)

ggplot(col_income) +
  geom_col(aes(factor(GEOID, levels = lvls), estimate, fill = label),
           position = "fill") +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1)) +
  labs(title = "Income Distribution for Each Columbus ZIP Code",
       x = "ZIP Code",
       y = "Proportion of Population", 
       fill = "Income Level")

# ANOVA
col_covid$ZIP <- as.character(col_covid$ZIP)
col_income_six_figure <- left_join(col_income_six_figure, col_covid, 
                                   by = c("GEOID" = "ZIP"))

income_lm <- lm(average ~ prop_100K, data = col_income_six_figure)
```

We see a nice distribution of six-figure incomes across the ZIP codes, ranging from just over 1\% in ZIP 43217 all the way to over 70\% of ZIP code 43212 making over \$100,000. 

Next, we performed an ANOVA test. The ANOVA test tells us if there is a significant difference in income within the groups of the COVID averages. When performing tha ANOVA test, we looked at the p-value and the R^2 value. The p-value tells us if there is a significant difference between the groups of ZIP codes and the R^2 value is related to the correlation. In simple terms the R^2 value is a rough measure of how much COVID can be explained by income.

The ANOVA test for proportion of people making over 100K resulted in a low p-value of 0.00767 and a fairly high R^2 value of 0.403. This indicates that there is some evidence to say that ZIP codes that are wealthier are correlated with having a higher COVID case rate.

### Race

Does data valiadate the statements about minorites being impacted by COVID more?

```{r}
col_race_clean <- get_acs(geography = "zcta",
                            table = "B02001") %>%
  filter(GEOID %in% zip_code_col$zip,
         variable %in% str_c("B02001_00", 2:8))

col_race <- left_join(col_race_clean, variables_2018[, 1:2], by = "variable")
col_race$label <- as_factor(str_replace(col_race$label, ".*!!(.*)", "\\1"))

col_race <- col_race %>%
  group_by(GEOID) %>%
  mutate(n = sum(estimate),
         prop = estimate/n)

lvls_col_race <- col_race %>%
  filter(str_detect(label, "White alone")) %>%
  arrange(prop) %>%
  pull(GEOID)

ggplot(col_race) +
  geom_col(aes(factor(GEOID, levels = lvls_col_race), estimate, fill = label),
           position = "fill") +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1),
        legend.position = "bottom") +
  labs(title = "Race Distribution for Each Columbus ZIP Code",
       x = "ZIP Code",
       y = "Proportion of Population",
       fill = "Race \nType")
```

Analyzing our race graph, we see black or African American individuals to make up a large proportion of the about 1/3 of the ZIP codes. In the other parts of Columbus's ZIP codes, white individuals make up most of the population. Once we pair COVID data with race, we may see interesting results.

```{r}
col_race <- left_join(col_race, col_covid, by = c("GEOID" = "ZIP"))

## ANOVA TEST
race_lm <- lm(prop ~ as.factor(average), data = col_race)
```

After performing statistical test, we see no evidence of a relationship between white individuals and COVID cases. Our p-value is not significant and our correlation is approximately zero.

### Gini Index

The Gini index is a measure of income inequality calculated by the Census Bureau using various different factors. The closer to 0 the Gini index, the more equally income is dispersed. A Gini index of 1 would indicate perfect inequality where a single group or individual collects all of the income. 

```{r}
col_gini <- get_acs(geography = "zcta",
                      table = "B19083")

geometry_zip_col$GEOID <- as.character(geometry_zip_col$GEOID)
col_gini <- left_join(col_gini, geometry_zip_col, by = "GEOID")

col_gini <- st_as_sf(col_gini, sf_column_name = "geometry")

col_gini <- col_gini %>%
  filter(GEOID %in% zip_code_col$zip) %>%
  left_join(variables_2018[, 1:2], by = "variable")

col_gini$label <- as_factor(str_replace(col_gini$label, ".*!!(.*)", "\\1"))
```

We can view a map of the Gini Index across Columbus ZIP codes:
```{r}
pal_gini <- colorNumeric(palette = "viridis", domain = col_gini$estimate)

col_gini %>%
  st_transform(crs = "+init=epsg:4326") %>%
  leaflet(width = "100%") %>%
  addProviderTiles(provider = "CartoDB.Positron") %>%
  addPolygons(popup = str_c("<strong>", col_gini$GEOID,
                            "</strong><br /> Gini Index: ", col_gini$estimate),
              weight = 2,
              smoothFactor = 0,
              fillOpacity = 0.7,
              color = ~ pal_gini(estimate)) %>%
  addLegend("bottomright",
            pal = pal_gini,
            values = ~ estimate,
            title = "Gini Index",
            opacity = 1) 

col_gini$GEOID <- as.character(col_gini$GEOID)
col_gini <- left_join(col_gini, col_covid, by = c("GEOID" = "ZIP"))
gini_lm <- lm(estimate ~ as.factor(average), data = col_gini)
```

We see that no real pattern emerges between the Gini Index and COVID. This is supported by our ANOVA test. The ANOVA test gave us a p-value that was 0.2679 and an R^2 value of 0.175. This means that the Gini Index is not correlated to the case rate of COVID.

### Insurance Coverage

Since access to private health insurance is not universal, we looked at the relationship between having some type of private health insurance and COVID as well as similarly looking at public health insurance. It is possible to have both public and private insurance, so these metrics are not mutually exclusive.

```{r}
col_hi_private <- get_acs(geography = "zcta",
                            table = "B27002") %>%
  filter(GEOID %in% zip_code_col$zip) %>%
  left_join(variables_2018[, 1:2], by = "variable") %>%
  filter(str_count(label, "!!") >= 4)

col_hi_public <- get_acs(geography = "zcta",
                           table = "B27003") %>%
  filter(GEOID %in% zip_code_col$zip) %>%
  left_join(variables_2018[, 1:2], by = "variable") %>%
  filter(str_count(label, "!!") >= 4)

col_hi_private$label <- str_remove(col_hi_private$label, "Estimate!!Total!!")
col_hi_public$label <- str_remove(col_hi_public$label, "Estimate!!Total!!")

col_hi_private <- separate(col_hi_private,
                             label,
                             sep = "!!",
                             into = c("Sex", "Age", "Private_HI"))
col_hi_public <- separate(col_hi_public,
                            label,
                            sep = "!!",
                            into = c("Sex", "Age", "Public_HI"))

col_hi_private$Private_HI <- if_else(
  col_hi_private$Private_HI == "No private health insurance", "No", "Yes")
col_hi_public$Public_HI <- if_else(
  col_hi_public$Public_HI == "No public coverage", "No", "Yes")

col_hi_private$Sex <- as_factor(col_hi_private$Sex)
col_hi_public$Sex <- as_factor(col_hi_public$Sex)
col_hi_private$Age <- as_factor(col_hi_private$Age)
col_hi_public$Age <- as_factor(col_hi_public$Age)
col_hi_private$Private_HI <- as_factor(col_hi_private$Private_HI)
col_hi_public$Public_HI <- as_factor(col_hi_public$Public_HI)
```

#### Private Health Insurance

We breakdown each ZIP code by the proportion of residents who have private health insurance.
```{r}
col_hi_private_2 <- col_hi_private %>% group_by(GEOID, Private_HI) %>%
  summarize(count = sum(estimate)) %>%
  ungroup() %>%
  group_by(GEOID) %>%
  mutate(pop = sum(count),
         prop = count/pop)

### Graph Private HI Coverage by proportion
lvls_col_hi_private <- col_hi_private_2 %>%
  filter(Private_HI == "Yes") %>%
  arrange(prop) %>%
  pull(GEOID)

ggplot(col_hi_private_2) +
  geom_col(aes(factor(GEOID, levels = lvls_col_hi_private), count, fill = Private_HI),
           position = "fill") +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1))

```

As we see, there is a wide range of those populations that have private health insurance, ranging from 97\% of the population in 43210 to only 19\% of the residents in 43222 having private health insurance. But how does this relate to COVID cases?

After performing the ANOVA test, we see evidence to suggest that there is not a correlation with private health insurance and the COVID case rate. From the ANOVA test we got an insignificant p-value of 0.191 and an R^2 value of 0.0582. In this case, as the proportion that have private health insurance increases, we see no change in the case rate.

#### Public Health Insurance

We breakdown each ZIP code by the proportion of residents who have public health insurance.
```{r}
col_hi_public <- get_acs(geography = "zcta",
                           table = "B27003") %>%
  filter(GEOID %in% zip_code_col$zip) %>%
  left_join(variables_2018[, 1:2], by = "variable") %>%
  filter(str_count(label, "!!") >= 4)

col_hi_public$label <- str_remove(col_hi_public$label, "Estimate!!Total!!")

col_hi_public <- separate(col_hi_public,
                            label,
                            sep = "!!",
                            into = c("Sex", "Age", "Public_HI"))

col_hi_public$Public_HI <- if_else(
  col_hi_public$Public_HI == "No public coverage", "No", "Yes")


col_hi_public$Sex <- as_factor(col_hi_public$Sex)
col_hi_public$Age <- as_factor(col_hi_public$Age)
col_hi_public$Public_HI <- as_factor(col_hi_public$Public_HI)

col_hi_public_2 <- col_hi_public %>% group_by(GEOID, Public_HI) %>%
  summarize(count = sum(estimate)) %>%
  ungroup() %>%
  group_by(GEOID) %>%
  mutate(pop = sum(count),
         prop = count/pop)

lvls_col_hi_public <- col_hi_public_2 %>%
  filter(Public_HI == "Yes") %>%
  arrange(prop) %>%
  pull(GEOID)

ggplot(col_hi_public_2) +
  geom_col(aes(factor(GEOID, levels = lvls_col_hi_public), count, fill = Public_HI),
           position = "fill") +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1)) +
    labs(title = "Public Health Insurance Seems to have a\nPositive Relation to COVID Case Rate",
       x = "Proportion of Population that has Public Health Insurance",
       y = "Case Rate (per 100,000)")

# ANOVA
col_hi_public_2 <- col_hi_public_2 %>% filter(Public_HI == "Yes")
col_hi_public_2 <- left_join(col_hi_public_2, col_covid, by = c("GEOID" = "ZIP"))
hi_lm2 <- lm(prop ~ as.factor(average), data = col_hi_public_2)
```

We still have a descent distinction between ZIP codes as to the proportion of their populations that have public insurance (ranges from 3\% to 70\%). After performing the ANOVA test, we see evidence to suggest that there is a correlation with public health insurance and the COVID case rate. From the ANOVA test we got a significant p-value of 0.0003 and a high R^2 value of 0.542. Indicating that there is evidence to suggest that ZIP codes with a higher proportion of people that have public health insurance does impact the COVID case rate. 

### Transportation to Work

The use of public transportation is more prevalent among lower incomes, while at the same time public transportation poses a higher risk of contracting COVID. We look to see if this idea plays out in the data for Columbus.

```{r}
col_trans <- get_acs(geography = "zcta",
                       table = "B08301") %>%
  filter(GEOID %in% zip_code_col$zip,
         variable %in% c("B08301_002", str_c("B08301_0", c(10, 16:21))))

col_trans <- left_join(col_trans, variables_2018[, 1:2], by = "variable")
col_trans$label <- as_factor(str_replace(col_trans$label, ".*!!(.*)", "\\1"))

col_trans <- col_trans %>%
  mutate(use_public = if_else(str_detect(label, "^Pub.*")|str_detect(label, "Taxicab"),
                              TRUE, FALSE))

col_trans_public <- col_trans %>%
  group_by(GEOID) %>%
  mutate(n = sum(estimate),
         prop = estimate/n) %>%
  filter(use_public == TRUE) %>%
  mutate(prop_public = sum(prop))

lvls_trans <- col_trans_public %>%
  arrange(prop_public) %>%
  distinct(GEOID) %>%
  pull(GEOID)

ggplot(col_trans) +
  geom_col(aes(factor(GEOID, levels = lvls_trans), estimate, fill = label),
           position = "fill") +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1),
        legend.position = "bottom") +
  labs(title = "Transportation Distribution for Each Columbus ZIP Code",
       x = "ZIP Code",
       y = "Proportion of Population",
       fill = "Transportation \nType")
```

The percentage of the population that uses public transportation is not too high, never reaching above 17\%. Most Columbus residents provide their own motorized transportation, while in a few ZIP codes walking and working from home is quite popular. 

```{r}
col_covid$ZIP <- as.character(col_covid$ZIP)
col_trans_public <- left_join(col_trans_public, col_covid, by = c("GEOID" = "ZIP"))
trans_lm <- lm(prop_public ~ as.factor(average), data = col_trans_public)
```

We see a moderate relationship between the use of public transportation and COVID. Conducting our tests gives us a correlation of 0.4950, R^2 equaling 0.245, and a p-value of 0.002612. Within the average categories, we see that the ZIP codes with average cases of 2085 and 3500 are significant in context to public transportation. This is an overall moderate correlation and indicates that as a ZIP code sees higher use of public transportation, it is also seeing a higher COVID rate.

## Conclusions

Many of the variables investigated had a noteable correlation. Essential occupations saw a moderate positive relationship to COVID cases, that is, the two variables increase together. Public transportation also reported a positive correlation with COVID data. The proportion of people who make over 100K additionally saw a positive correlation with COVID data. Race and citizenship had no relationship and no significant impact when compared to COVID cases.







