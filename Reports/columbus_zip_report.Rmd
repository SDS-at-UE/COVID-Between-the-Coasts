---
title: 'COVID-19: A Midwestern Reporting Project of WNIN and the University of Evansville'
author: "Columbus ZIP Code Analysis"
date: "Analysis performed by Maya Frederick, Timmy Miller, Ethan Morlock, Pearl Muensterman, and Darrin Weber, Ph.D."
output: html_document
urlcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
options(scipen = 999, digits = 6)
library(tidycensus)
library(tidyverse)
library(leaflet)
library(sf)
library(tigris)
library(readxl)
options(tigris_use_cache = TRUE)
variables_2018 <- load_variables(2018, "acs5", cache = TRUE) %>%
  rename(variable = name)
zip_code <- read_csv("../Data/zip_county.csv")
zip_code_col <- zip_code %>% filter(primary_city == "Columbus", state == "OH")
geometry_zip <- read_sf("../Data/All_zips.shp", type = 6)
geometry_zip_col <- filter(geometry_zip, GEOID %in% zip_code_col$zip)
col_covid <- read_excel("../Data/columbus_covid.xlsx")
```

## Background

The goal of this analysis is to find any connections, if they exist, between demographic data and the outbreak of COVID-19 in the city of Columbus. Demographic data was obtained from the Census Bureau through their 5-year American Community Survey published in 2018 (the most recent 5-year data available). COVID-19 case numbers were obtained from the Columbus Public Health Department ([https://public.tableau.com/views/COVID-19OutbreakSummary_15918845768300/COVID19Summaryp3?%3Adisplay_count=y&%3Aorigin=viz_share_link&%3AshowVizHome=no]). 

Throughout the document, we report the $p$-value for several statistical tests. This does nothing more than provide a measure on the amount of evidence we have to suggest statistical significance. The closer the $p$-value is to 0 the stronger the evidence that our measure (correlation most of the time) is different than 0. 

**Conclusions:**

## Analysis

### COVID

We first look at the COVID cases by ZIP codes. The city of Columbus reported their data in ranges instead of exact numbers. To be able to conduct analysis we took the average of that particular range for that ZIP code. That is why ZIP codes of the same color have the exact same case rate. Columbus does not seem to have any outliers as there is a nice spread of the COVID case rate. As you can see the more metropolitan areas have a little bit higher case rate which is what is expected. 

```{r}
geometry_zip_col$GEOID <- as.numeric(geometry_zip_col$GEOID)
col_covid_geo <- left_join(col_covid, geometry_zip_col, by = c("ZIP" = "GEOID"))
col_covid_geo <- st_as_sf(col_covid_geo, sf_column_name = "geometry")
```

```{r}
pal <- colorNumeric(palette = "viridis", domain = col_covid_geo$average)
col_covid_geo %>% 
  st_transform(crs = "+init=epsg:4326") %>% 
  leaflet(width = "100%") %>% 
  addProviderTiles(provider = "CartoDB.Positron") %>% 
  addPolygons(popup = str_c("<strong>", col_covid_geo$ZIP,
                            "</strong><br /> Case Rate ", signif(col_covid_geo$average, digits = 4)),
              weight = 4,
              smoothFactor = 0,
              fillOpacity = 0.7,
              color = ~ pal(average)) %>% 
  addLegend("bottomright",
            pal = pal,
            values = ~ average,
            title = "Case Rate (per 100000)",
            opacity = 1)
```

### Income
```{r}
col_income <- get_acs(geography = "zcta",
                        table = "B19101") %>% 
  filter(GEOID %in% zip_code_col$zip,
         !variable %in% c("B19101_001"))
col_income <- left_join(col_income, variables_2018[, 1:2], by = "variable")
col_income$label <- as_factor(str_replace(col_income$label, ".*!!(.*)", "\\1"))
geometry_zip_col$GEOID <- as.character(geometry_zip_col$GEOID)
col_income <- left_join(col_income, geometry_zip_col, by = "GEOID")
col_income <- st_as_sf(col_income, sf_column_name = "geometry")
```

We look at the income data in increments designated by the Census Bureau. We calculated the proportion of people making over \$100,000 to order the ZIP codes on the $x$-axis in the following graph. 

```{r}
col_income_six_figure <- col_income %>% 
  group_by(GEOID) %>% 
  mutate(n = sum(estimate),
         prop = estimate/n) %>% 
  filter(label %in% c("$200,000 or more",
                      "$150,000 to $199,999",
                      "$125,000 to $149,999",
                      "$100,000 to $124,999")) %>% 
  mutate(prop_100K = sum(prop)) %>% 
  select(GEOID, prop_100K) %>% 
  distinct(GEOID, prop_100K)

lvls <- col_income_six_figure %>% 
  arrange(prop_100K) %>% 
  pull(GEOID)

ggplot(col_income) +
  geom_col(aes(factor(GEOID, levels = lvls), estimate, fill = label),
           position = "fill") +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1)) +
  labs(title = "Income Distribution for Each Columbus ZIP Code",
       x = "ZIP Code",
       y = "Proportion of Population", 
       fill = "Income Level")
  
```

Next, we performed an ANOVA test. The ANOVA test tells us if there is a significant difference in income within the groups of the COVID averages. 

### Gini Index
```{r}
col_gini <- get_acs(geography = "zcta",
                      table = "B19083")

geometry_zip_col$GEOID <- as.character(geometry_zip_col$GEOID)
col_gini <- left_join(col_gini, geometry_zip_col, by = "GEOID")

col_gini <- st_as_sf(col_gini, sf_column_name = "geometry")

col_gini <- col_gini %>% 
  filter(GEOID %in% zip_code_col$zip) %>% 
  left_join(variables_2018[, 1:2], by = "variable")

col_gini$label <- as_factor(str_replace(col_gini$label, ".*!!(.*)", "\\1"))
```

# Map Gini Index
```{r}
pal_gini <- colorNumeric(palette = "viridis", domain = col_gini$estimate)

col_gini %>% 
  st_transform(crs = "+init=epsg:4326") %>% 
  leaflet(width = "100%") %>% 
  addProviderTiles(provider = "CartoDB.Positron") %>% 
  addPolygons(popup = str_c("<strong>", col_gini$GEOID,
                            "</strong><br /> Gini Index: ", col_gini$estimate),
              weight = 2,
              smoothFactor = 0,
              fillOpacity = 0.7,
              color = ~ pal_gini(estimate)) %>% 
  addLegend("bottomright",
            pal = pal_gini,
            values = ~ estimate,
            title = "Gini Index",
            opacity = 1)
```

## ANOVA TEST
```{r}
col_covid$ZIP <- as.character(col_covid$ZIP)
col_gini <- left_join(col_gini, col_covid, by = c("GEOID" = "ZIP"))

gini_lm <- lm(average ~ estimate, data = col_gini)
summary(gini_lm)
anova(gini_lm)
```
R^2 = 0.06735. This value indicates how much varability is explained by our model i.e. how much cases is explained by a gini index. This is a small value. Our linear model and anova test give no significance of values with p-value of 0.1586.


### Health Insurance Coverage (by sex by age)
```{r}
col_sex_age <- get_acs(geography = "zcta",
                         table = "B27001") %>% 
  filter(GEOID %in% zip_code_col$zip) %>% 
  left_join(variables_2018[, 1:2], by = "variable")

col_sex_age <- col_sex_age %>% filter(str_count(label, "!!") >= 4)

col_sex_age$label <- str_remove(col_sex_age$label, "Estimate!!Total!!")

col_sex_age <- separate(col_sex_age,
                          label,
                          sep = "!!",
                          into = c("Sex", "Age", "HI_Coverage"))

col_sex_age$HI_Coverage <- if_else(
  col_sex_age$HI_Coverage == "No health insurance coverage", "No", "Yes")

col_sex_age$Sex <- as_factor(col_sex_age$Sex)
col_sex_age$Age <- as_factor(col_sex_age$Age)
col_sex_age$HI_Coverage <- as_factor(col_sex_age$HI_Coverage)  
```

# Look at Health Insurance Coverage
```{r}
col_HI <- col_sex_age %>% group_by(GEOID, HI_Coverage) %>% 
  summarize(count = sum(estimate)) %>% 
  ungroup() %>% 
  group_by(GEOID) %>% 
  mutate(pop = sum(count),
         prop = count/pop)
```

# Graph Health Insurance Coverage by proportion
```{r}
lvls_col_HI <- col_HI %>% 
  filter(HI_Coverage == "Yes") %>% 
  arrange(prop) %>% 
  pull(GEOID)

ggplot(col_HI) +
  geom_col(aes(factor(GEOID, levels = lvls_col_HI), count, fill = HI_Coverage),
           position = "fill") +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1))

```




#### Private Health Insurance
```{r}
col_hi_private <- get_acs(geography = "zcta",
                            table = "B27002") %>% 
  filter(GEOID %in% zip_code_col$zip) %>% 
  left_join(variables_2018[, 1:2], by = "variable") %>% 
  filter(str_count(label, "!!") >= 4)

col_hi_private$label <- str_remove(col_hi_private$label, "Estimate!!Total!!")

col_hi_private <- separate(col_hi_private,
                             label,
                             sep = "!!",
                             into = c("Sex", "Age", "Private_HI"))

col_hi_private$Private_HI <- if_else(
  col_hi_private$Private_HI == "No private health insurance", "No", "Yes")

col_hi_private$Sex <- as_factor(col_hi_private$Sex)
col_hi_private$Age <- as_factor(col_hi_private$Age)
col_hi_private$Private_HI <- as_factor(col_hi_private$Private_HI)
```

## Look at Private HI Coverage
```{r}
col_hi_private_2 <- col_hi_private %>% group_by(GEOID, Private_HI) %>% 
  summarize(count = sum(estimate)) %>% 
  ungroup() %>% 
  group_by(GEOID) %>% 
  mutate(pop = sum(count),
         prop = count/pop)
```

# Graph Private HI Coverage by proportion
```{r}
lvls_col_hi_private <- col_hi_private_2 %>% 
  filter(Private_HI == "Yes") %>% 
  arrange(prop) %>% 
  pull(GEOID)

ggplot(col_hi_private_2) +
  geom_col(aes(factor(GEOID, levels = lvls_col_hi_private), count, fill = Private_HI),
           position = "fill") +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1))
```

## ANOVA TEST
```{r}
col_hi_private_2 <- col_hi_private_2 %>% filter(Private_HI == "Yes")
col_hi_private_2 <- left_join(col_hi_private_2, col_covid, by = c("GEOID" = "ZIP"))

hi_lm <- lm(average ~ prop, data = col_hi_private_2)
summary(hi_lm)
anova(hi_lm)
```
We have a small R^2 value again of 0.05815. Our anova test suggests there is nothing significant between private health insurance and COVID-19 cases. The p-value is 0.1913



#### Public Health Insurance
```{r}
col_hi_public <- get_acs(geography = "zcta",
                           table = "B27003") %>% 
  filter(GEOID %in% zip_code_col$zip) %>% 
  left_join(variables_2018[, 1:2], by = "variable") %>% 
  filter(str_count(label, "!!") >= 4)

col_hi_public$label <- str_remove(col_hi_public$label, "Estimate!!Total!!")

col_hi_public <- separate(col_hi_public,
                            label,
                            sep = "!!",
                            into = c("Sex", "Age", "Public_HI"))

col_hi_public$Public_HI <- if_else(
  col_hi_public$Public_HI == "No public coverage", "No", "Yes")


col_hi_public$Sex <- as_factor(col_hi_public$Sex)
col_hi_public$Age <- as_factor(col_hi_public$Age)
col_hi_public$Public_HI <- as_factor(col_hi_public$Public_HI) 
```

## Look at Public HI Coverage
```{r}
col_hi_public_2 <- col_hi_public %>% group_by(GEOID, Public_HI) %>% 
  summarize(count = sum(estimate)) %>% 
  ungroup() %>% 
  group_by(GEOID) %>% 
  mutate(pop = sum(count),
         prop = count/pop)
```

# Graph Public HI Coverage by proportion
```{r}
lvls_col_hi_public <- col_hi_public_2 %>% 
  filter(Public_HI == "Yes") %>% 
  arrange(prop) %>% 
  pull(GEOID)

ggplot(col_hi_public_2) +
  geom_col(aes(factor(GEOID, levels = lvls_col_hi_public), count, fill = Public_HI),
           position = "fill") +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1))
```

## ANOVA TEST
```{r}
col_hi_public_2 <- col_hi_public_2 %>% filter(Public_HI == "Yes")
col_hi_public_2 <- left_join(col_hi_public_2, col_covid, by = c("GEOID" = "ZIP"))

hi_lm <- lm(average ~ prop, data = col_hi_public_2)
summary(hi_lm)
anova(hi_lm)
```
R^2 = 0.01857. P-value of 0.4648 - not significant

### Age

### Occupation

### Public Transportation

### Citizenship

### Race