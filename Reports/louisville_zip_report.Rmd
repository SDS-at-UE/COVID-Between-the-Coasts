---
title: 'COVID-19: A Midwestern Reporting Project of WNIN and the University of Evansville'
author: "Louisville Zip Code Analysis"
date: "9/4/2020"
output: html_document
urlcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
options(scipen = 999, digits = 4)
#See louisville_eda.R for code comments
library(tidycensus)
library(tidyverse)
library(leaflet)
library(stringr)
library(sf)
library(tigris)
options(tigris_use_cache = TRUE)
variables_2018 <- load_variables(2018, "acs5", cache = TRUE) %>%
  rename(variable = name)
zip_code <- read_csv("../Data/zip_county.csv")
zip_code_louis <- zip_code %>% filter(primary_city == "Louisville",
                                      state == "KY")
geometry_zip <- read_sf("../Data/All_zips.shp", type = 6)
geometry_zip_louis <- filter(geometry_zip, GEOID %in% zip_code_louis$zip)
louis_covid <- read_csv("../Data/louisville_covid.csv",
                        col_types = cols(ZIP = col_character()))
louis_covid <- louis_covid %>% 
  mutate(case_rate = Cases/Population) %>% 
  rename(zip = ZIP,
         population = Population,
         cases = Cases)
```

## Background

The goal of this analysis is to find any connections, if they exist, between demographic data and the outbreak of COVID-19 in the city of Louisville. Demographic data was obtained from the Census Bureau through their 5-year American Community Survey published in 2018 (the most recent 5-year data available). COVID-19 case numbers were obtained from the Louisville Metro Department of Public Health and Wellness ([https://covid-19-in-jefferson-county-ky-lojic.hub.arcgis.com/](https://covid-19-in-jefferson-county-ky-lojic.hub.arcgis.com/)). 

Throughout the document, we report the $p$-value for several statistical tests. This does nothing more than provide a measure on the amount of evidence we have to suggest statistical significance. The closer the $p$-value is to 0 the stronger the evidence that our measure (correlation most of the time) is different than 0. 

**This paragraph would summarize some of the results for a quick reference**

## Analysis

### Income

```{r}
louis_income <- get_acs(geography = "zcta",
                        table = "B19101") %>% 
  filter(GEOID %in% zip_code_louis$zip,
         !variable %in% c("B19101_001"))

louis_income <- left_join(louis_income, geometry_zip_louis, by = "GEOID")
louis_income <- st_as_sf(louis_income, sf_column_name = "geometry")

louis_income <- left_join(louis_income, variables_2018[, 1:2], by = "variable")

louis_income$label <- as_factor(str_replace(louis_income$label, ".*!!(.*)", "\\1"))

louis_income_six_figure <- louis_income %>% 
  group_by(GEOID) %>% 
  mutate(n = sum(estimate),
         prop = estimate/n) %>% 
  filter(label %in% c("$200,000 or more",
                      "$150,000 to $199,999",
                      "$125,000 to $149,999",
                      "$100,000 to $124,999")) %>% 
  mutate(prop_100K = sum(prop)) %>% 
  select(GEOID, prop_100K) %>% 
  distinct(GEOID, prop_100K)

lvls_income <- louis_income_six_figure %>% 
  arrange(prop_100K) %>% 
  pull(GEOID)

louis_income <- left_join(louis_income, louis_covid, by = c("GEOID" = "zip"))
```


We look at the income data in increments designated by the Census Bureau. We calculated the proportion of people making over \$100,000 to order the zip codes on the $x$-axis in the following graph. 

```{r}
ggplot(louis_income) +
  geom_col(aes(factor(GEOID, levels = lvls_income), estimate, fill = label),
           position = "fill") +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1)) +
  labs(title = "Income Distribution for Each Louisville ZIP Code",
       x = "ZIP Code",
       y = "Proportion of Population", 
       fill = "Income Level")
  
```

Zip code 40231 has no data, which is true throughout the analysis. We can compare the remaining zip codes with the case rate (per 100000) of COVID in the same zip codes. 

```{r}
pal <- colorNumeric(palette = "viridis", domain = louis_income$case_rate)
louis_income %>% 
  st_transform(crs = "+init=epsg:4326") %>% 
  leaflet(width = "100%") %>% 
  addProviderTiles(provider = "CartoDB.Positron") %>% 
  addPolygons(popup = str_c("<strong>", louis_income$GEOID,
                            "</strong><br /> Case Rate ", signif(louis_income$case_rate, digits = 4)),
              weight = 4,
              smoothFactor = 0,
              fillOpacity = 0.7,
              color = ~ pal(case_rate)) %>% 
  addLegend("bottomright",
            pal = pal,
            values = ~ case_rate,
            title = "Case Rate (per 100000)",
            opacity = 1)
```

```{r}
louis_income_cor <- left_join(louis_income_six_figure, louis_covid, by = c("GEOID"="zip"))
```

The next graph shows that it appears to have some correlation, i.e., the poorer the zip code the more likely to have a higher rate of infection. 

```{r}
ggplot(louis_income_cor, aes(prop_100K, case_rate)) +
  geom_point() +
  labs(title = "Slight Negative Correlation Between Infection and Income",
       subtitle = "ZIP code 40202 is an outlier.",
       x = "Proportion of Population that Makes >$100,000",
       y = "Case Rate (per 100,000)") +
  ggrepel::geom_label_repel(data = filter(louis_income_cor, case_rate > .03),
                            aes(label = GEOID))
```

```{r}
louis_income_cor_sans40202 <- louis_income_cor %>% 
  filter(case_rate < .03)
```

The 40202 ZIP code is a clear outlier. We remove this from the data to run a viable correlation test between the case rate and the proportion of the population that makes over \$100,000. We get a statistically significant ($p=$ `r cor.test(louis_income_cor_sans40202$prop_100K, louis_income_cor_sans40202$case_rate, use = "complete.obs")$p.value`) correlation value of `r cor.test(louis_income_cor_sans40202$prop_100K, louis_income_cor_sans40202$case_rate, use = "complete.obs")$estimate`. This verifies that there is indeed a moderately negative correlation with case rate and higher incomes.


### Gini Index

The Gini index is a measure of income inequality calculated by the Census Bureau using various different factors. The closer to 0 the Gini index, the more equal income is dispersed. A Gini index of 1 would indicate perfect inequality where a single group or individual collects all of the income. 

```{r}
louis_gini <- get_acs(geography = "zcta",
                      table = "B19083")
louis_gini <- left_join(louis_gini, geometry_zip_louis, by = "GEOID")
louis_gini <- st_as_sf(louis_gini, sf_column_name = "geometry")
louis_gini <- louis_gini %>% 
  filter(GEOID %in% zip_code_louis$zip) %>% 
  left_join(variables_2018[, 1:2], by = "variable")

louis_gini$label <- as_factor(str_replace(louis_gini$label, ".*!!(.*)", "\\1"))
```

Below, we map the Gini index onto each ZIP code to give an idea of the variation between ZIP codes.

```{r}
pal_gini <- colorNumeric(palette = "viridis", domain = louis_gini$estimate)

louis_gini %>% 
  st_transform(crs = "+init=epsg:4326") %>% 
  leaflet(width = "100%") %>% 
  addProviderTiles(provider = "CartoDB.Positron") %>% 
  addPolygons(popup = str_c("<strong>", louis_gini$GEOID,
                            "</strong><br /> Gini Index: ", louis_gini$estimate),
              weight = 2,
              smoothFactor = 0,
              fillOpacity = 0.7,
              color = ~ pal_gini(estimate)) %>% 
  addLegend("bottomright",
            pal = pal_gini,
            values = ~ estimate,
            title = "Gini Index",
            opacity = 1)
```

We also provide a scatterplot to visualize the connection between COVID case rate and the Gini Index. As we can see, ZIP code 40202 is an outlier and will be removed in future analysis. 

```{r}
louis_gini_cor <- left_join(louis_gini, louis_covid, by = c("GEOID"="zip"))
ggplot(louis_gini_cor, aes(estimate, case_rate)) +
  geom_point() +
  labs(title = "No Discernible Correlation Between Gini Index and COVID",
       x = "Gini Index",
       y = "Case Rate (per 100,000)") +
  ggrepel::geom_label_repel(data = filter(louis_gini_cor, case_rate > .03),
                            aes(label = GEOID))
louis_gini_cor_sans40202 <- filter(louis_gini_cor, case_rate < .03)
```

After removing 40202, we see that there is no real correlation between the Gini Index and the rate of infection for COVID. We get a correlation of `r cor.test(louis_gini_cor_sans40202$estimate, louis_gini_cor_sans40202$case_rate, use = "complete.obs")$estimate` ($p=$ `
`r cor.test(louis_gini_cor_sans40202$estimate, louis_gini_cor_sans40202$case_rate, use = "complete.obs")$p.value`), and thus indistinguishable from 0. 

### Health Insurance Coverage

We looked at the how much of the population has health insurance, regardless of whether it was public or private. The graph below shows the distribution of health insurance coverage across the Louisville ZIP codes. 

```{r}
louis_sex_age <- get_acs(geography = "zcta",
                         table = "B27001") %>% 
  filter(GEOID %in% zip_code_louis$zip) %>% 
  left_join(variables_2018[, 1:2], by = "variable")

louis_sex_age <- louis_sex_age %>% filter(str_count(label, "!!") >= 4)

louis_sex_age$label <- str_remove(louis_sex_age$label, "Estimate!!Total!!")

louis_sex_age <- separate(louis_sex_age,
                          label,
                          sep = "!!",
                          into = c("Sex", "Age", "HI_Coverage"))

louis_sex_age$HI_Coverage <- if_else(louis_sex_age$HI_Coverage == "No health insurance coverage", "No", "Yes")

louis_sex_age$Sex <- as_factor(louis_sex_age$Sex)
louis_sex_age$Age <- as_factor(louis_sex_age$Age)
louis_sex_age$HI_Coverage <- as_factor(louis_sex_age$HI_Coverage)  
```

```{r}
## Look at Health Insurance Coverage

louis_HI <- louis_sex_age %>% group_by(GEOID, HI_Coverage) %>% 
  summarize(count = sum(estimate)) %>% 
  ungroup() %>% 
  group_by(GEOID) %>% 
  mutate(pop = sum(count),
         prop = count/pop)

### Graph Health Insurance Coverage by proportion

lvls_louis_HI <- louis_HI %>% 
  filter(HI_Coverage == "Yes") %>% 
  arrange(prop) %>% 
  pull(GEOID)

ggplot(louis_HI) +
  geom_col(aes(factor(GEOID, levels = lvls_louis_HI), count, fill = HI_Coverage),
           position = "fill") +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1)) +
  labs(title = "Health Care Coverage for Each Louisville ZIP Code",
       x = "ZIP Code",
       y = "Proportion of Population", 
       fill = "Health Insurance \nCoverage?")
```

A vast majority of Louisville residents have health insurance, although there is quite a distinction between the 40218 ZIP code and the 40245 ZIP code. To see any correlation with COVID, we can look at a scatterplot.

```{r}
louis_HI_cor <- left_join(louis_HI, louis_covid, by = c("GEOID"="zip"))

filter(louis_HI_cor, HI_Coverage == "Yes") %>%
  ggplot(aes(prop, case_rate)) +
  geom_point() +
  labs(title = "Slight Correlation Between Health Insurance Coverage and COVID",
       x = "Proportion of Population that has Health Insurance",
       y = "Case Rate (per 100,000)") +
  ggrepel::geom_label_repel(data = filter(louis_HI_cor, case_rate > .03, HI_Coverage == "Yes"),
                            aes(label = GEOID))
```

```{r}
louis_HI_cor_sans40202 <- louis_HI_cor %>% 
  filter(HI_Coverage == "Yes",
         case_rate < .03)
```

There appears to be a definitive correlation, once we remove 40202. We end up with a moderate to strong correlation value of `r cor.test(louis_HI_cor_sans40202$prop, louis_HI_cor_sans40202$case_rate, use = "complete.obs")$estimate` ($p=$ `r signif(cor.test(louis_HI_cor_sans40202$prop, louis_HI_cor_sans40202$case_rate, use = "complete.obs")$p.value, digits = 2)`).

### Private Health Insurance vs. Public Health Insurance

Since access to private health insurance is not universal, we looked at the relationship between having some type of private health insurance and COVID as well as similarly looking at public health insurance. It is possible to have both public and private insurance, so these metrics are not mutually exclusive.

```{r}
louis_hi_private <- get_acs(geography = "zcta",
                            table = "B27002") %>% 
  filter(GEOID %in% zip_code_louis$zip) %>% 
  left_join(variables_2018[, 1:2], by = "variable") %>% 
  filter(str_count(label, "!!") >= 4)

louis_hi_public <- get_acs(geography = "zcta",
                           table = "B27003") %>% 
  filter(GEOID %in% zip_code_louis$zip) %>% 
  left_join(variables_2018[, 1:2], by = "variable") %>% 
  filter(str_count(label, "!!") >= 4)

louis_hi_private$label <- str_remove(louis_hi_private$label, "Estimate!!Total!!")
louis_hi_public$label <- str_remove(louis_hi_public$label, "Estimate!!Total!!")

louis_hi_private <- separate(louis_hi_private,
                             label,
                             sep = "!!",
                             into = c("Sex", "Age", "Private_HI"))
louis_hi_public <- separate(louis_hi_public,
                            label,
                            sep = "!!",
                            into = c("Sex", "Age", "Public_HI"))

louis_hi_private$Private_HI <- if_else(louis_hi_private$Private_HI == "No private health insurance", "No", "Yes")
louis_hi_public$Public_HI <- if_else(louis_hi_public$Public_HI == "No public coverage", "No", "Yes")

louis_hi_private$Sex <- as_factor(louis_hi_private$Sex)
louis_hi_public$Sex <- as_factor(louis_hi_public$Sex)
louis_hi_private$Age <- as_factor(louis_hi_private$Age)
louis_hi_public$Age <- as_factor(louis_hi_public$Age)
louis_hi_private$Private_HI <- as_factor(louis_hi_private$Private_HI)
louis_hi_public$Public_HI <- as_factor(louis_hi_public$Public_HI) 
```

#### Private Health Insurance

We breakdown each ZIP code by the proportion of residents who have private health insurance.

```{r}
louis_hi_private_2 <- louis_hi_private %>% group_by(GEOID, Private_HI) %>% 
  summarize(count = sum(estimate)) %>% 
  ungroup() %>% 
  group_by(GEOID) %>% 
  mutate(pop = sum(count),
         prop = count/pop)

### Graph Private HI Coverage by proportion

lvls_louis_hi_private <- louis_hi_private_2 %>% 
  filter(Private_HI == "Yes") %>% 
  arrange(prop) %>% 
  pull(GEOID)

ggplot(louis_hi_private_2) +
  geom_col(aes(factor(GEOID, levels = lvls_louis_hi_private), count, fill = Private_HI),
           position = "fill") +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1)) +
  labs(title = "Prevalence of Private Health Insurance for Each Louisville ZIP Code",
       x = "ZIP Code",
       y = "Proportion of Population", 
       fill = "Private Health \nInsurance Coverage?")
```

As we see, there is a wide range of those populations that have private health insurance, ranging from almost 90% of the population in 40245 to only 31.4% of the residents in 40210 having private health insurance. But how does this relate to COVID cases.

```{r}
louis_hi_private_cor <- left_join(louis_hi_private_2, louis_covid, by = c("GEOID"="zip")) %>% 
  filter(Private_HI == "Yes")

louis_hi_private_cor %>%
  ggplot(aes(prop, case_rate)) +
  geom_point() +
  ggrepel::geom_label_repel(data = filter(louis_hi_private_cor, case_rate > .03),
                                          aes(label = GEOID)) +
  labs(title = "Possession of Private Health Insurance Seems \nto be Grouped by Another Factor",
       x = "Proportion of Population that has Private Health Insurance",
       y = "Case Rate (per 100,000)")
```

The graph shows that we don't have a correlation between the case rate of COVID and having private insurance. However, this grouping is interesting. It turns out it is geographically based as the next map shows. We split the proportion of private health insurance into three groups: low, medium, and high. The *low* group has less than 45% of its population possessing private health insurance. The *medium* group has between 45% and 65%, and the *high* group has over 65% of its population with private health insurance.

```{r}
louis_hi_private_cor <- louis_hi_private_cor %>% 
  mutate(hi_group = factor(if_else(prop < .5, "low",
                            if_else(prop < .65, "medium",
                                    "high")),
                           levels = c("low", "medium", "high")))
louis_hi_private_cor <- left_join(louis_hi_private_cor, geometry_zip_louis, by = "GEOID")
louis_hi_private_cor <- st_as_sf(louis_hi_private_cor, sf_column_name = "geometry")

pal_hi <- colorFactor(palette = c('purple', 'seagreen', 'red3'), domain = louis_hi_private_cor$hi_group)

louis_hi_private_cor %>% 
  st_transform(crs = "+init=epsg:4326") %>% 
  leaflet(width = "100%") %>% 
  addProviderTiles(provider = "CartoDB.Positron") %>% 
  addPolygons(popup = str_c("<strong>", louis_hi_private_cor$GEOID,
                            "</strong><br /> Prop. w/ Private HI: ", louis_hi_private_cor$prop),
              weight = 4,
              smoothFactor = 0,
              fillOpacity = 0.7,
              color = ~ pal_hi(hi_group)) %>% 
  addLegend("bottomright",
            pal = pal_hi,
            values = ~ hi_group,
            title = "Private Health \n Insurance Groups",
            opacity = 1)
```

#### Public Health Insurance




### Age

We know people over 65 years of age are at higher risk of mortality from COVID. But we wanted to know if they are catching COVID at a higher rate. Is Louisville doing a good job of protecting their senior citizens? To answer this, we can look at the breakdown of ages in each of the ZIP codes and compare the proportion of senior citizens in each ZIP code to the case rate of COVID.

```{r}
louis_age <- louis_sex_age %>% 
  group_by(GEOID) %>% 
  mutate(n = sum(estimate),
         prop = estimate/n) %>% 
  filter(Age %in% c("65 to 74 years",
                    "75 years and over")) %>% 
  mutate(prop_over65 = sum(prop)) %>% 
  arrange(prop_over65)
```

We start with our basic graphic displaying the distribution of ages throughout the ZIP codes.

```{r}
lvls_age <- louis_sex_age %>% 
  group_by(GEOID) %>% 
  mutate(n = sum(estimate),
         prop = estimate/n) %>% 
  filter(Age %in% c("65 to 74 years",
                    "75 years and over")) %>% 
  mutate(prop_over65 = sum(prop)) %>% 
  arrange(prop_over65) %>% 
  select(GEOID, prop_over65) %>% 
  distinct(GEOID, prop_over65) %>% 
  pull(GEOID)
ggplot(louis_sex_age) +
  geom_col(aes(factor(GEOID, levels = lvls_age), estimate, fill = Age),
           position = "fill") +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1)) +
  labs(title = "Age Distribution for Louisville ZIP Codes",
       x = "ZIP Code",
       y = "Proportion of Population", 
       fill = "Age Ranges")
```

We focus on the relationship between COVID cases and the proportion of the population that is 65 years or older.

```{r}
louis_age_cor <- left_join(louis_age, louis_covid, by = c("GEOID"="zip"))

ggplot(louis_age_cor, aes(prop_over65, case_rate)) +
  geom_point() +
  labs(title = "Slight Correlation Between Proportion of Population Over 65 and COVID",
       x = "Proportion of Population Over Age 65",
       y = "Case Rate (per 100,000)") +
  ggrepel::geom_label_repel(data = filter(louis_age_cor, case_rate > .03)[1,],
                            aes(label = GEOID))
louis_age_cor_sans40202 <- filter(louis_age_cor, case_rate < .03)
```

There appears to be a slight correlation. After removal of the 40202 outlier, we get a correlation value of `r cor.test(louis_age_cor_sans40202$prop_over65, louis_age_cor_sans40202$case_rate, use = "complete.obs")$estimate` ($p=$ `r cor.test(louis_age_cor_sans40202$prop_over65, louis_age_cor_sans40202$case_rate, use = "complete.obs")$p.value`).


## Conclusions

Here we would put in our conclusions.
